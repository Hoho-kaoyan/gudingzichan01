# 功能模块详细说明

本文档详细说明固定资产管理系统的各个功能模块及其实现。

## 1. 认证模块 (auth.py)

### 功能说明
负责用户身份验证和权限管理。

### 核心功能
- **EHR号验证**：检查输入的EHR号是否存在，如果存在则返回用户名
- **用户登录**：使用EHR号和密码进行登录，返回JWT token
- **Token验证**：验证JWT token并获取当前用户信息
- **权限控制**：区分管理员和普通用户的权限

### 实现细节
- 使用JWT（JSON Web Token）进行无状态认证
- 密码使用bcrypt加密存储
- Token有效期30天
- 支持基于角色的访问控制（RBAC）

### API接口
- `POST /api/auth/check-ehr` - 检查EHR号
- `POST /api/auth/login` - 用户登录

## 2. 用户管理模块 (users.py)

### 功能说明
管理系统中所有用户的信息，包括管理员和普通用户。

### 核心功能
- **用户列表**：查看所有用户（仅管理员）
- **用户详情**：查看指定用户的详细信息
- **创建用户**：添加新用户（仅管理员）
- **更新用户**：修改用户信息（仅管理员）
- **删除用户**：删除用户（仅管理员）
- **批量导入**：通过Excel文件批量导入用户（仅管理员）

### 数据模型
- EHR号（7位数字，唯一标识）
- 真实姓名
- 组别（如：第1组、管理组）
- 角色（admin/user）
- 密码（加密存储）

### Excel导入格式
| EHR号 | 姓名 | 组别 | 角色 | 密码 |
|-------|------|------|------|------|
| 1234567 | 张三 | 第1组 | user | 123456 |

### API接口
- `GET /api/users/` - 获取用户列表
- `GET /api/users/me` - 获取当前用户信息
- `GET /api/users/{id}` - 获取指定用户
- `POST /api/users/` - 创建用户
- `PUT /api/users/{id}` - 更新用户
- `DELETE /api/users/{id}` - 删除用户
- `POST /api/users/import` - 批量导入用户

## 3. 资产管理模块 (assets.py)

### 功能说明
管理所有固定资产的信息，包括实物情况和盘点情况。

### 核心功能
- **资产列表**：查看所有资产，支持筛选（资产编号、大类、状态、使用人、关键词搜索）
- **资产详情**：查看指定资产的详细信息
- **创建资产**：添加新资产
- **更新资产**：修改资产信息
  - 管理员可直接更新
  - 普通用户更新需提交编辑申请，等待审批
- **删除资产**：删除资产（软删除，保留历史记录）
- **批量导入**：通过Excel文件批量导入资产（仅管理员）
- **导出功能**：支持导出资产列表为Excel

### 数据模型

#### 实物情况
- 资产编号（唯一）
- 所属大类（关联AssetCategory）
- 实物名称
- 规格型号（可选）
- 状态（在用/库存备用）
- MAC地址（可选）
- IP地址（可选）

#### 盘点情况
- 存放办公地点
- 存放楼层
- 座位号（可选）
- 使用人（关联User）
- 使用人组别
- 备注说明（可选）

### Excel导入格式
| 资产编号 | 所属大类 | 实物名称 | 规格型号 | 状态 | MAC地址 | IP地址 | 存放办公地点 | 存放楼层 | 座位号 | 使用人EHR号 | 使用人组别 | 备注说明 |
|---------|---------|---------|---------|------|---------|--------|------------|---------|--------|------------|-----------|----------|
| ASSET001 | 电子设备配件 | 主机 | i7-9700 | 在用 | 00:11:22:33:44:55 | 192.168.1.100 | 办公楼A | 3楼 | A-101 | 1234567 | 第1组 | 备用主机 |

### API接口
- `GET /api/assets/` - 获取资产列表（支持筛选和搜索）
- `GET /api/assets/{id}` - 获取指定资产
- `POST /api/assets/` - 创建资产
- `PUT /api/assets/{id}` - 更新资产
- `DELETE /api/assets/{id}` - 删除资产（软删除）
- `POST /api/assets/import` - 批量导入资产

## 4. 资产交接模块 (transfers.py)

### 功能说明
处理资产从A员工转移到B员工的申请流程。

### 核心功能
- **申请交接**：提交资产交接申请
- **查看申请**：查看交接申请列表和详情
- **权限控制**：普通用户只能查看自己相关的申请

### 业务流程
1. 用户选择要交接的资产
2. 选择转入用户
3. 填写交接原因（可选）
4. 提交申请，状态为"pending"
5. 管理员审批
6. 如果批准，资产的使用人更新为转入用户，并自动更新使用人组别

### 数据模型
- 资产ID（关联Asset）
- 转出用户ID（关联User）
- 转入用户ID（关联User）
- 申请创建人ID（可能是管理员代为申请）
- 交接原因
- 审批状态（pending/approved/rejected）
- 审批人ID（关联User）
- 审批意见
- 审批时间

### API接口
- `GET /api/transfers/` - 获取交接申请列表
- `GET /api/transfers/{id}` - 获取指定交接申请
- `POST /api/transfers/` - 创建交接申请

## 5. 资产退回模块 (returns.py)

### 功能说明
处理资产退回仓库的申请流程，通常用于员工离职时。

### 核心功能
- **申请退回**：提交资产退回仓库申请
- **查看申请**：查看退回申请列表和详情
- **权限控制**：普通用户只能查看自己的申请
- **修改资产信息**：申请退回时可同时修改资产的MAC地址、IP地址、存放地点等信息

### 业务流程
1. 用户选择要退回的资产
2. 填写退回原因（可选）
3. 可选择修改资产的MAC地址、IP地址、存放地点等信息
4. 提交申请，状态为"pending"
5. 管理员审批
6. 如果批准：
   - 资产的使用人清空
   - 资产状态变为"库存备用"
   - 清空存放地点和楼层信息（或使用申请中填写的信息）

### 数据模型
- 资产ID（关联Asset）
- 退回用户ID（关联User）
- 退回原因
- 审批状态（pending/approved/rejected）
- 审批人ID（关联User）
- 审批意见
- 审批时间
- 申请人修改的字段（可选）：
  - MAC地址
  - IP地址
  - 存放办公地点
  - 存放楼层
  - 座位号
  - 新保管人ID
  - 备注说明

### API接口
- `GET /api/returns/` - 获取退回申请列表
- `GET /api/returns/{id}` - 获取指定退回申请
- `POST /api/returns/` - 创建退回申请

## 6. 资产编辑申请模块 (edit_requests.py)

### 功能说明
处理普通用户修改资产信息的申请流程。

### 核心功能
- **申请编辑**：提交资产编辑申请
- **查看申请**：查看编辑申请列表和详情
- **权限控制**：普通用户只能查看自己的申请，且只能编辑自己名下的资产

### 业务流程
1. 用户选择要编辑的资产（只能是自己名下的）
2. 修改需要更新的字段（普通用户不能修改使用人）
3. 提交申请，状态为"pending"
4. 管理员审批
5. 如果批准，资产信息按申请内容更新

### 数据模型
- 资产ID（关联Asset）
- 申请人ID（关联User）
- 编辑数据（JSON格式，包含要修改的字段）
- 审批状态（pending/approved/rejected）
- 审批人ID（关联User）
- 审批意见
- 审批时间

### 可编辑字段
- 实物名称
- 规格型号
- 状态
- MAC地址
- IP地址
- 存放办公地点
- 存放楼层
- 座位号
- 使用人（仅管理员可修改）
- 使用人组别
- 备注说明

### API接口
- `GET /api/edit-requests/` - 获取编辑申请列表（支持搜索）
- `GET /api/edit-requests/{id}` - 获取指定编辑申请
- `POST /api/edit-requests/` - 创建编辑申请

## 7. 审批管理模块 (approvals.py)

### 功能说明
管理员审批资产交接、退回和编辑申请。

### 核心功能
- **审批交接申请**：批准或拒绝资产交接申请
- **审批退回申请**：批准或拒绝资产退回申请
- **审批编辑申请**：批准或拒绝资产编辑申请
- **自动更新资产**：批准后自动更新资产信息
- **记录历史**：所有审批操作都会记录到资产历史中

### 审批流程
1. 管理员查看待审批的申请列表（交接、退回、编辑）
2. 选择批准或拒绝
3. 填写审批意见（可选）
4. 提交审批
5. 系统自动更新资产信息（如果批准）
6. 记录操作历史

### 审批结果处理

#### 批准交接
- 资产的使用人更新为转入用户
- 自动更新使用人组别
- 记录交接历史

#### 批准退回
- 资产的使用人清空（或更新为新保管人）
- 资产状态变为"库存备用"
- 更新存放地点等信息（如果申请中有填写）
- 记录退回历史

#### 批准编辑
- 资产信息按申请内容更新
- 记录编辑历史

#### 拒绝
- 申请状态更新为"rejected"
- 资产信息不变
- 记录拒绝历史

### API接口
- `POST /api/approvals/approve` - 审批申请

## 8. 资产历史记录模块 (asset_history.py)

### 功能说明
记录资产的所有操作历史，包括创建、编辑、交接、退回、审批、删除等。

### 核心功能
- **查看历史**：查看指定资产的完整流转记录
- **操作类型**：记录不同类型的操作
- **变更详情**：记录操作前后的值变化
- **操作人信息**：记录操作人和审批人信息

### 操作类型
- `create`：创建资产
- `edit`：编辑资产
- `transfer`：资产交接
- `return`：资产退回
- `approve`：审批操作
- `edit_approve`：编辑申请审批
- `delete`：删除资产

### 数据模型
- 资产ID（关联Asset）
- 操作类型
- 操作描述
- 操作人ID（关联User）
- 审批人ID（关联User，如有）
- 旧值（JSON格式）
- 新值（JSON格式）
- 关联申请ID
- 关联申请类型（transfer/return/edit）
- 操作时间

### API接口
- `GET /api/asset-history/asset/{asset_id}` - 获取指定资产的流转记录

## 9. 资产大类模块 (categories.py)

### 功能说明
管理资产的分类，如办公用品、电子设备配件等。

### 核心功能
- **大类列表**：查看所有资产大类
- **创建大类**：添加新的资产大类

### 数据模型
- 大类名称（唯一）

### API接口
- `GET /api/categories/` - 获取资产大类列表
- `POST /api/categories/` - 创建资产大类

## 10. 统计模块 (stats.py)

### 功能说明
提供系统统计数据，用于首页看板展示。

### 核心功能
- **用户总数**：统计系统中的用户数量
- **资产总数**：统计系统中的资产数量
- **在用资产数**：统计状态为"在用"的资产数量
- **待审批数量**：统计待审批的交接和退回申请总数

### API接口
- `GET /api/stats/` - 获取系统统计数据

## 前端页面说明

### 1. 登录页面 (Login.jsx)
- 输入EHR号后自动验证并显示用户名
- 输入密码完成登录
- 使用JWT token进行后续请求认证

### 2. 首页 (Dashboard.jsx)
- 显示系统统计信息
- 资产总数、在用资产、用户总数、待审批数量
- 使用卡片形式展示统计数据

### 3. 用户管理页面 (UserManagement.jsx)
- 用户列表展示
- 新增、编辑、删除用户
- Excel批量导入功能
- 搜索和筛选功能

### 4. 资产管理页面 (AssetManagement.jsx)
- 资产列表展示（支持筛选和搜索）
- 新增、编辑、删除资产
- Excel批量导入功能（仅管理员）
- 查看资产历史记录
- 可调整列宽的表格

### 5. 资产历史记录页面 (AssetHistory.jsx)
- 显示资产的完整流转记录
- 时间线形式展示
- 显示操作类型、操作人、变更详情等

### 6. 资产交接页面 (TransferManagement.jsx)
- 交接申请列表
- 提交新的交接申请
- 查看申请状态
- 搜索和筛选功能

### 7. 资产退回页面 (ReturnManagement.jsx)
- 退回申请列表
- 提交新的退回申请
- 查看申请状态
- 申请时可修改资产信息

### 8. 审批管理页面 (ApprovalManagement.jsx)
- 待审批申请列表（交接、退回、编辑）
- 使用标签页分类显示
- 审批操作（批准/拒绝）
- 填写审批意见
- 查看申请详情

## 权限控制

### 管理员权限
- 查看所有用户和资产
- 管理用户（增删改查、批量导入）
- 直接编辑资产（无需审批）
- 审批所有申请（交接、退回、编辑）
- 管理资产大类
- 删除资产

### 普通用户权限
- 查看自己的资产
- 编辑自己名下的资产（需提交申请，等待审批）
- 提交资产交接和退回申请
- 查看自己相关的申请状态
- 查看资产大类列表
- 查看资产历史记录

## 数据流转

### 资产交接流程
```
用户A → 提交交接申请 → 管理员审批 → 批准 → 资产转移到用户B → 记录历史
```

### 资产退回流程
```
用户 → 提交退回申请 → 管理员审批 → 批准 → 资产退回仓库 → 记录历史
```

### 资产编辑流程
```
用户 → 提交编辑申请 → 管理员审批 → 批准 → 资产信息更新 → 记录历史
```

## 技术实现要点

### 后端
- 使用FastAPI的依赖注入实现权限控制
- 使用SQLAlchemy ORM进行数据库操作
- 使用Pydantic进行数据验证
- 使用JWT进行无状态认证
- 软删除机制，保留历史记录
- 自动记录操作历史

### 前端
- 使用React Context管理全局状态（认证信息）
- 使用React Router进行路由管理
- 使用Ant Design提供UI组件
- 使用Axios进行HTTP请求，自动添加token
- 支持表格列宽调整

### 数据库
- SQLite数据库（可替换为PostgreSQL/MySQL）
- 使用SQLAlchemy进行ORM映射
- 自动创建数据库表结构
- 软删除机制（deleted_at字段）

## 扩展建议

1. **数据导出**：添加Excel导出功能（已部分实现）
2. **资产盘点**：定期盘点功能
3. **资产维修**：维修记录管理
4. **报表统计**：各类统计报表
5. **消息通知**：审批结果通知
6. **操作日志**：记录所有操作历史（已实现资产历史）
7. **多级审批**：支持多级审批流程
8. **批量操作**：批量审批、批量交接等
9. **资产标签**：支持给资产打标签
10. **资产照片**：支持上传资产照片
