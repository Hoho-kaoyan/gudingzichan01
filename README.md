# 固定资产管理系统

一个基于Python FastAPI后端和React + Ant Design前端的固定资产管理系统，支持资产的增删改查、交接、审批、退回、历史记录等功能。

## 功能特性

### 核心功能
- ✅ **资产管理**：资产的增删改查、批量导入导出、软删除
- ✅ **资产交接**：资产从A员工转到B员工的申请流程，支持转入人确认
- ✅ **资产退回**：员工离职时资产退回仓库的申请流程
- ✅ **资产编辑申请**：普通用户修改资产信息需管理员审批，可查看审批状态和意见
- ✅ **流程审批**：管理员审批交接、退回和编辑申请
- ✅ **资产历史记录**：完整记录资产的所有操作历史，字段名显示为中文
- ✅ **用户管理**：用户增删改查、批量导入（仅管理员）
- ✅ **统计看板**：首页显示系统统计数据
- ✅ **安全检查任务**：管理员发布安全检查任务，普通用户完成检查并提交结果
  - 检查类型管理：支持动态添加、编辑检查类型和检查项
  - 任务发布：批量选择资产，选择检查类型，发布任务
  - 任务分配：任务自动分配给资产的使用人
  - 任务执行：普通用户查看任务，逐项完成检查并提交结果
  - 进度跟踪：实时显示任务完成进度
  - 历史记录：记录所有检查历史
- ✅ **侧边栏通知**：待审批、待确认交接、待检查任务的数量提示

### 用户角色
- **管理员**：拥有所有权限，包括审批和用户管理
- **普通用户**：可以查看和管理自己的资产，提交交接、退回和编辑申请

### 数据模型

#### 用户信息
- EHR号（7位数字，唯一标识）
- 真实姓名
- 组别（如：第1组、管理组）
- 角色（管理员/普通用户）

#### 固定资产信息
**实物情况：**
- 资产编号（唯一）
- 所属大类（如：办公用品、电子设备配件）
- 实物名称
- 规格型号（可选）
- 状态（在用/库存备用）
- MAC地址（可选）
- IP地址（可选）

**盘点情况：**
- 存放办公地点
- 存放楼层
- 座位号（可选）
- 使用人
- 使用人组别
- 备注说明（可选）

## 技术栈

### 后端
- **FastAPI**：现代、快速的Web框架
- **SQLAlchemy**：ORM数据库操作
- **SQLite**：轻量级数据库（可替换为PostgreSQL/MySQL）
- **JWT**：用户认证
- **Pandas + OpenPyXL**：Excel批量导入

### 前端
- **React 18**：UI框架
- **Ant Design 5**：UI组件库
- **React Router**：路由管理
- **Axios**：HTTP客户端
- **Vite**：构建工具

## 项目结构

```
.
├── backend/                 # 后端代码
│   ├── routers/            # API路由
│   │   ├── auth.py         # 认证相关
│   │   ├── users.py        # 用户管理
│   │   ├── assets.py       # 资产管理
│   │   ├── transfers.py    # 资产交接
│   │   ├── returns.py       # 资产退回
│   │   ├── edit_requests.py # 资产编辑申请
│   │   ├── approvals.py    # 审批管理
│   │   ├── asset_history.py # 资产历史记录
│   │   ├── categories.py   # 资产大类
│   │   ├── stats.py        # 统计信息
│   │   ├── safety_check_types.py    # 安全检查类型管理
│   │   ├── safety_check_tasks.py    # 安全检查任务管理
│   │   └── safety_check_results.py  # 安全检查结果提交
│   ├── models.py           # 数据库模型
│   ├── schemas.py          # Pydantic模式
│   ├── auth.py             # 认证工具
│   ├── database.py         # 数据库配置
│   ├── main.py             # 应用入口
│   ├── init_db.py          # 数据库初始化
│   └── requirements.txt    # Python依赖
│
├── frontend/               # 前端代码
│   ├── src/
│   │   ├── pages/          # 页面组件
│   │   │   ├── Login.jsx           # 登录页
│   │   │   ├── Dashboard.jsx       # 首页（统计看板）
│   │   │   ├── UserManagement.jsx  # 用户管理
│   │   │   ├── AssetManagement.jsx  # 资产管理
│   │   │   ├── AssetHistory.jsx     # 资产历史记录
│   │   │   ├── TransferManagement.jsx  # 资产交接
│   │   │   ├── ReturnManagement.jsx    # 资产退回
│   │   │   ├── ApprovalManagement.jsx  # 审批管理
│   │   │   ├── SafetyCheckTaskManagement.jsx  # 安全检查任务管理（管理员）
│   │   │   └── MySafetyCheckTasks.jsx  # 我的检查任务（普通用户）
│   │   ├── components/     # 公共组件
│   │   │   ├── Layout.jsx      # 布局组件
│   │   │   ├── PrivateRoute.jsx # 路由守卫
│   │   │   └── ResizableTitle.jsx # 可调整列宽标题
│   │   ├── contexts/       # Context
│   │   │   ├── AuthContext.jsx  # 认证上下文
│   │   │   └── TransferContext.jsx  # 交接和审批上下文（包含通知数量）
│   │   ├── utils/          # 工具函数
│   │   │   └── api.js       # API客户端
│   │   ├── App.jsx         # 应用入口
│   │   └── main.jsx        # 入口文件
│   ├── package.json        # 前端依赖
│   └── vite.config.js     # Vite配置
│
└── README.md              # 项目说明
```

## 安装和运行

### 后端

1. 进入后端目录：
```bash
cd backend
```

2. 创建虚拟环境（如果还没有）：
```bash
python -m venv venv
```

3. 激活虚拟环境：
- Windows:
```bash
venv\Scripts\activate
```
- Linux/Mac:
```bash
source venv/bin/activate
```

4. 安装依赖：
```bash
pip install -r requirements.txt
```

5. 初始化数据库（创建管理员账户和资产大类）：
```bash
python init_db.py
```

6. 运行后端服务：
```bash
uvicorn main:app --reload --port 8000
```

后端API文档：http://localhost:8000/docs

### 前端

1. 进入前端目录：
```bash
cd frontend
```

2. 安装依赖：
```bash
npm install
```

3. 运行开发服务器：
```bash
npm run dev
```

前端应用：http://localhost:3000

## 使用说明

### 登录功能

1. 在登录页面输入7位EHR号
2. 系统会自动验证EHR号，如果存在则显示用户名
3. 输入密码完成登录

**默认管理员账户：**
- EHR号：0000001
- 密码：admin123

### 用户管理（仅管理员）

- **新增用户**：点击"新增用户"按钮，填写用户信息
- **编辑用户**：点击用户列表中的"编辑"按钮
- **删除用户**：点击"删除"按钮（需确认）
- **批量导入**：点击"批量导入"按钮，上传Excel文件

**Excel导入格式：**
| EHR号 | 姓名 | 组别 | 角色 | 密码 |
|-------|------|------|------|------|
| 1234567 | 张三 | 第1组 | user | 123456 |

### 资产管理

- **新增资产**：点击"新增资产"按钮，填写资产信息
- **编辑资产**：点击资产列表中的"编辑"按钮
  - 管理员可直接编辑所有资产
  - 普通用户只能编辑自己名下的资产，且修改需管理员审批
- **删除资产**：点击"删除"按钮（需确认，软删除）
- **查看历史**：点击"历史"按钮查看资产的完整流转记录
- **批量导入**：点击"批量导入"按钮，上传Excel文件（仅管理员）

**Excel导入格式：**
| 资产编号 | 所属大类 | 实物名称 | 规格型号 | 状态 | MAC地址 | IP地址 | 存放办公地点 | 存放楼层 | 座位号 | 使用人EHR号 | 使用人组别 | 备注说明 |
|---------|---------|---------|---------|------|---------|--------|------------|---------|--------|------------|-----------|----------|
| ASSET001 | 电子设备配件 | 主机 | i7-9700 | 在用 | 00:11:22:33:44:55 | 192.168.1.100 | 办公楼A | 3楼 | A-101 | 1234567 | 第1组 | 备用主机 |

### 资产交接

1. 点击"申请交接"按钮
2. 选择要交接的资产
3. 选择转入用户
4. 填写交接原因（可选）
5. 提交申请，等待管理员审批

### 资产退回

1. 点击"申请退回"按钮
2. 选择要退回的资产
3. 填写退回原因（可选）
4. 提交申请，等待管理员审批

### 资产编辑申请

1. 在资产管理页面点击"编辑"按钮
2. 修改需要更新的字段（普通用户不能修改使用人）
3. 提交编辑申请，等待管理员审批
4. 管理员审批通过后，资产信息才会更新

### 审批管理（仅管理员）

1. 在"审批管理"页面查看待审批的申请（交接、退回、编辑）
2. 点击"审批"按钮
3. 选择"批准"或"拒绝"
4. 填写审批意见（可选）
5. 提交审批

**审批结果：**
- **批准交接**：资产的使用人更新为转入用户，自动更新使用人组别
- **批准退回**：资产退回仓库，状态变为"库存备用"，清空使用人信息
- **批准编辑**：资产信息按申请内容更新
- **拒绝**：申请被拒绝，资产状态不变

### 资产历史记录

- 在资产管理页面点击"流转记录"按钮，可查看资产的完整流转记录
- 记录包括：创建、编辑、交接、退回、审批、删除等所有操作
- 显示操作人、审批人、操作时间、变更详情等信息
- 字段名自动转换为中文显示（如"使用人"而不是"user_id"）

### 安全检查任务（管理员）

1. **检查类型管理**：
   - 在"安全检查任务"页面点击"检查类型管理"按钮
   - 添加、编辑、删除检查类型
   - 为每个检查类型配置检查项（必填/可选）

2. **发布任务**：
   - 点击"发布新任务"按钮
   - 选择检查类型
   - 填写任务标题、描述、截止时间
   - 选择要检查的资产（支持多选）
   - 提交后，任务自动分配给资产的使用人

3. **查看任务进度**：
   - 在任务列表中查看所有任务
   - 点击"查看详情"查看任务进度和资产完成情况
   - 显示已完成、待检查、已退库的资产数量

### 我的检查任务（普通用户）

1. **查看任务**：
   - 在"我的检查任务"页面查看分配给自己的任务
   - 侧边栏会显示待检查资产的数量提示

2. **完成检查**：
   - 点击"开始检查"或"查看详情"
   - 逐项完成每个资产的检查
   - 对每个检查项选择"是"或"否"，并填写备注
   - 填写整体检查结果和备注
   - 提交检查结果

3. **查看历史**：
   - 在"已完成"标签页查看已完成的检查任务
   - 查看历史检查记录

## API接口说明

### 认证接口
- `POST /api/auth/check-ehr` - 检查EHR号是否存在
- `POST /api/auth/login` - 用户登录

### 用户管理接口
- `GET /api/users/` - 获取用户列表（管理员）
- `GET /api/users/me` - 获取当前用户信息
- `GET /api/users/{id}` - 获取指定用户
- `POST /api/users/` - 创建用户（管理员）
- `PUT /api/users/{id}` - 更新用户（管理员）
- `DELETE /api/users/{id}` - 删除用户（管理员）
- `POST /api/users/import` - 批量导入用户（管理员）

### 资产管理接口
- `GET /api/assets/` - 获取资产列表（支持筛选和搜索）
- `GET /api/assets/{id}` - 获取指定资产
- `POST /api/assets/` - 创建资产
- `PUT /api/assets/{id}` - 更新资产（管理员直接更新，普通用户需审批）
- `DELETE /api/assets/{id}` - 删除资产（软删除）
- `POST /api/assets/import` - 批量导入资产（仅管理员）

### 资产交接接口
- `GET /api/transfers/` - 获取交接申请列表
- `GET /api/transfers/{id}` - 获取指定交接申请
- `POST /api/transfers/` - 创建交接申请

### 资产退回接口
- `GET /api/returns/` - 获取退回申请列表
- `GET /api/returns/{id}` - 获取指定退回申请
- `POST /api/returns/` - 创建退回申请

### 资产编辑申请接口
- `GET /api/edit-requests/` - 获取编辑申请列表
- `GET /api/edit-requests/{id}` - 获取指定编辑申请
- `POST /api/edit-requests/` - 创建编辑申请

### 审批接口
- `POST /api/approvals/approve` - 审批申请（管理员）

### 资产历史记录接口
- `GET /api/asset-history/asset/{asset_id}` - 获取指定资产的流转记录

### 资产大类接口
- `GET /api/categories/` - 获取资产大类列表
- `POST /api/categories/` - 创建资产大类

### 统计接口
- `GET /api/stats/` - 获取系统统计数据

### 安全检查接口
- `GET /api/safety-check-types/` - 获取检查类型列表（管理员）
- `GET /api/safety-check-types/{id}` - 获取指定检查类型
- `POST /api/safety-check-types/` - 创建检查类型（管理员）
- `PUT /api/safety-check-types/{id}` - 更新检查类型（管理员）
- `DELETE /api/safety-check-types/{id}` - 删除检查类型（管理员）
- `GET /api/safety-check-tasks/` - 获取任务列表
- `GET /api/safety-check-tasks/{id}` - 获取任务详情
- `POST /api/safety-check-tasks/` - 创建任务（管理员）
- `GET /api/safety-check-tasks/{id}/assets` - 获取任务资产列表
- `GET /api/safety-check-results/my-tasks` - 获取我的任务（普通用户）
- `GET /api/safety-check-results/task/{task_id}/assets` - 获取任务资产（普通用户）
- `POST /api/safety-check-results/submit` - 提交检查结果（普通用户）
- `GET /api/safety-check-results/asset/{asset_id}/history` - 获取资产检查历史

## 数据库初始化

系统首次运行时会自动创建数据库表。使用 `init_db.py` 脚本可以：

1. 创建默认管理员账户（EHR号：0000001，密码：admin123）
2. 初始化常用资产大类

运行方式：
```bash
cd backend
python init_db.py
```

## 注意事项

1. **生产环境配置**：
   - 修改 `backend/auth.py` 中的 `SECRET_KEY`
   - 考虑使用PostgreSQL或MySQL替代SQLite
   - 配置HTTPS
   - 设置适当的CORS策略

2. **Excel导入**：
   - 确保Excel文件格式正确
   - 列名必须与文档中的格式一致
   - 导入时会自动创建不存在的资产大类
   - 详细导入格式请参考 `批量导入指南.md`

3. **权限控制**：
   - 普通用户只能查看和管理自己的资产
   - 普通用户编辑资产需要管理员审批
   - 只有管理员可以审批申请和管理用户

4. **软删除**：
   - 资产删除采用软删除机制，不会真正删除数据
   - 删除的资产不会在列表中显示，但历史记录会保留

## 开发说明

### 后端开发
- 使用FastAPI的自动文档功能：http://localhost:8000/docs
- 数据库迁移可以使用Alembic（可选）
- 日志记录在 `backend/logs/` 目录

### 前端开发
- 使用Vite作为构建工具，支持热重载
- Ant Design组件库提供丰富的UI组件
- 使用Context API管理全局状态（认证信息）

## 新功能特性

### 安全检查模块
- **检查类型管理**：支持动态配置检查类型和检查项
- **任务发布**：管理员批量选择资产发布检查任务
- **任务分配**：任务自动分配给资产使用人
- **逐项检查**：支持多检查项，逐项完成并记录结果
- **进度跟踪**：实时显示任务完成进度
- **历史记录**：完整记录所有检查历史

### 用户体验优化
- **侧边栏通知**：显示待审批、待确认交接、待检查任务的数量
- **字段名中文化**：流转记录中字段名自动转换为中文
- **编辑申请状态**：普通用户可查看编辑申请的审批状态和意见
- **安全检查任务同步**：资产交接、退回、编辑时自动更新安全检查任务

### 权限控制增强
- **普通用户限制**：普通用户不能修改资产状态
- **安全检查任务同步**：资产流转时自动更新安全检查任务分配

## 相关文档

- [快速启动指南](快速启动指南.md) - 快速启动项目
- [开发者指南](开发者指南.md) - 开发者快速上手指南
- [批量导入教程](批量导入指南.md) - Excel批量导入数据
- [功能模块详细说明](功能模块说明.md) - 各功能模块详细说明
- [安全检查功能设计方案](安全检查功能设计方案.md) - 安全检查功能设计文档
- [内网迁移指南](内网迁移指南.md) - 从SQLite迁移到Oracle/SQL Server（详细步骤）
- [迁移快速参考](迁移快速参考.md) - 迁移关键步骤快速查找
- [数据库配置示例](数据库配置示例.md) - 数据库配置快速参考

## 许可证

MIT License

## 联系方式

如有问题或建议，请提交Issue或Pull Request。
