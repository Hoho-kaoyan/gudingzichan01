# 固定资产管理系统 - 功能测试文档（黑盒测试）

## 文档信息

- **文档版本**: 1.0
- **测试类型**: 黑盒测试
- **测试范围**: 固定资产管理系统所有功能模块
- **测试方法**: 功能测试、边界测试、异常测试、权限测试

---

## 1. 测试环境

### 1.1 系统环境
- **后端**: FastAPI
- **前端**: React
- **数据库**: SQLite
- **认证方式**: JWT Token

### 1.2 测试账号
- **管理员账号**: EHR号: 1000000, 角色: admin
- **普通用户账号**: EHR号: 1234567, 角色: user

---

## 2. 认证模块测试

### 2.1 EHR号验证

#### TC-AUTH-001: 验证存在的EHR号
- **测试步骤**:
  1. 发送POST请求到 `/api/auth/check-ehr`
  2. 请求体: `{"ehr_number": "1234567"}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"exists": true, "real_name": "用户姓名"}`

#### TC-AUTH-002: 验证不存在的EHR号
- **测试步骤**:
  1. 发送POST请求到 `/api/auth/check-ehr`
  2. 请求体: `{"ehr_number": "9999999"}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"exists": false, "real_name": null}`

#### TC-AUTH-003: 验证EHR号格式错误
- **测试步骤**:
  1. 发送POST请求到 `/api/auth/check-ehr`
  2. 请求体: `{"ehr_number": "12345"}` (少于7位)
- **预期结果**: 
  - 状态码: 422 (验证错误)

### 2.2 用户登录

#### TC-AUTH-004: 正确登录
- **前置条件**: 用户已存在
- **测试步骤**:
  1. 发送POST请求到 `/api/auth/login`
  2. 请求体: `{"ehr_number": "1234567", "password": "正确密码"}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含 `access_token` 和用户信息

#### TC-AUTH-005: 错误密码登录
- **测试步骤**:
  1. 发送POST请求到 `/api/auth/login`
  2. 请求体: `{"ehr_number": "1234567", "password": "错误密码"}`
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "密码错误"}`

#### TC-AUTH-006: 不存在的用户登录
- **测试步骤**:
  1. 发送POST请求到 `/api/auth/login`
  2. 请求体: `{"ehr_number": "9999999", "password": "123456"}`
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "用户不存在"}`

---

## 3. 用户管理模块测试

### 3.1 获取用户列表

#### TC-USER-001: 管理员获取用户列表
- **前置条件**: 已使用管理员账号登录，获取token
- **测试步骤**:
  1. 发送GET请求到 `/api/users/`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回用户列表数组

#### TC-USER-002: 普通用户获取用户列表
- **前置条件**: 已使用普通用户账号登录，获取token
- **测试步骤**:
  1. 发送GET请求到 `/api/users/`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回用户列表数组（普通用户也可以查看用户列表用于选择）

#### TC-USER-003: 搜索用户
- **测试步骤**:
  1. 发送GET请求到 `/api/users/?search=张三`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含"张三"的用户列表

#### TC-USER-004: 按角色筛选用户
- **测试步骤**:
  1. 发送GET请求到 `/api/users/?role=admin`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回角色为admin的用户列表

### 3.2 获取当前用户信息

#### TC-USER-005: 获取当前登录用户信息
- **测试步骤**:
  1. 发送GET请求到 `/api/users/me`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回当前登录用户的详细信息

#### TC-USER-006: 未登录获取用户信息
- **测试步骤**:
  1. 发送GET请求到 `/api/users/me`
  2. 不提供Authorization头
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "未认证"}`

### 3.3 获取指定用户

#### TC-USER-007: 获取存在的用户
- **测试步骤**:
  1. 发送GET请求到 `/api/users/1`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回用户ID为1的详细信息

#### TC-USER-008: 获取不存在的用户
- **测试步骤**:
  1. 发送GET请求到 `/api/users/99999`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "用户不存在"}`

### 3.4 创建用户（仅管理员）

#### TC-USER-009: 管理员创建新用户
- **前置条件**: 已使用管理员账号登录
- **测试步骤**:
  1. 发送POST请求到 `/api/users/`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 请求体: 
     ```json
     {
       "ehr_number": "7654321",
       "real_name": "测试用户",
       "group": "第1组",
       "role": "user",
       "password": "123456"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的用户信息

#### TC-USER-010: 普通用户尝试创建用户
- **前置条件**: 已使用普通用户账号登录
- **测试步骤**:
  1. 发送POST请求到 `/api/users/`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体: 同上
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只有管理员可以执行此操作"}`

#### TC-USER-011: 创建重复EHR号的用户
- **测试步骤**:
  1. 发送POST请求到 `/api/users/`
  2. 请求体: EHR号已存在的用户信息
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "EHR号已存在"}`

#### TC-USER-012: 创建EHR号格式错误的用户
- **测试步骤**:
  1. 发送POST请求到 `/api/users/`
  2. 请求体: `{"ehr_number": "12345", ...}` (少于7位)
- **预期结果**: 
  - 状态码: 422 (验证错误)

### 3.5 更新用户（仅管理员）

#### TC-USER-013: 管理员更新用户信息
- **测试步骤**:
  1. 发送PUT请求到 `/api/users/1`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 请求体: 
     ```json
     {
       "real_name": "新姓名",
       "group": "第2组"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回更新后的用户信息

#### TC-USER-014: 更新不存在的用户
- **测试步骤**:
  1. 发送PUT请求到 `/api/users/99999`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "用户不存在"}`

### 3.6 删除用户（仅管理员）

#### TC-USER-015: 管理员删除用户
- **测试步骤**:
  1. 发送DELETE请求到 `/api/users/1`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"message": "用户已删除"}`

#### TC-USER-016: 尝试删除仓库用户
- **测试步骤**:
  1. 发送DELETE请求到 `/api/users/{warehouse_user_id}` (EHR号为1000000)
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "不能删除仓库用户"}`

### 3.7 批量导入用户（仅管理员）

#### TC-USER-017: 正确格式的Excel导入
- **测试步骤**:
  1. 发送POST请求到 `/api/users/import`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 上传包含正确格式的Excel文件（列：EHR号、姓名、组别、角色、密码）
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"success_count": N, "error_count": 0, "errors": []}`

#### TC-USER-018: 缺少必需列的Excel导入
- **测试步骤**:
  1. 上传缺少"EHR号"列的Excel文件
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "Excel文件缺少必需的列：EHR号"}`

#### TC-USER-019: 包含重复EHR号的Excel导入
- **测试步骤**:
  1. 上传包含重复EHR号的Excel文件
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"success_count": N, "error_count": M, "errors": ["第X行：EHR号已存在", ...]}`

---

## 4. 资产大类管理模块测试

### 4.1 获取资产大类列表

#### TC-CAT-001: 获取所有资产大类
- **测试步骤**:
  1. 发送GET请求到 `/api/categories/`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回资产大类列表

### 4.2 创建资产大类

#### TC-CAT-002: 创建新的大类
- **测试步骤**:
  1. 发送POST请求到 `/api/categories/`
  2. 请求头: `Authorization: Bearer {token}`
  3. 请求体: `{"name": "办公用品"}`
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的大类信息

#### TC-CAT-003: 创建重复的大类名称
- **测试步骤**:
  1. 发送POST请求到 `/api/categories/`
  2. 请求体: `{"name": "已存在的大类名称"}`
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "该大类已存在"}`

---

## 5. 资产管理模块测试

### 5.1 获取资产列表

#### TC-ASSET-001: 获取所有资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回资产列表（只包含未删除的资产）

#### TC-ASSET-002: 按资产编号筛选
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?asset_number=ASSET001`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回匹配的资产列表

#### TC-ASSET-003: 按大类筛选
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?category_id=1`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回指定大类的资产列表

#### TC-ASSET-004: 按状态筛选
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?status=在用`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回状态为"在用"的资产列表

#### TC-ASSET-005: 管理员按使用人筛选
- **前置条件**: 已使用管理员账号登录
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?user_id=1`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回指定用户的资产列表

#### TC-ASSET-006: 普通用户尝试按使用人筛选
- **前置条件**: 已使用普通用户账号登录
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?user_id=1`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "仅管理员可按使用人筛选资产"}`

#### TC-ASSET-007: 搜索资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?search=笔记本电脑`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含"笔记本电脑"的资产列表（模糊搜索）

#### TC-ASSET-008: 分页查询
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?skip=0&limit=10`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回最多10条资产记录

### 5.2 获取指定资产

#### TC-ASSET-009: 获取存在的资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/1`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回资产详细信息

#### TC-ASSET-010: 普通用户查看自己的资产
- **前置条件**: 资产属于当前用户
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/{asset_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回资产详细信息

#### TC-ASSET-011: 普通用户查看他人的资产
- **前置条件**: 资产不属于当前用户
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/{other_user_asset_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "无权查看此资产"}`

#### TC-ASSET-012: 获取不存在的资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/99999`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "资产不存在"}`

### 5.3 创建资产

#### TC-ASSET-013: 管理员创建资产
- **测试步骤**:
  1. 发送POST请求到 `/api/assets/`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 请求体:
     ```json
     {
       "asset_number": "ASSET001",
       "category_id": 1,
       "name": "笔记本电脑",
       "specification": "ThinkPad X1",
       "status": "在用",
       "mac_address": "00:11:22:33:44:55",
       "ip_address": "192.168.1.100",
       "office_location": "办公室A",
       "floor": "3楼",
       "seat_number": "A01",
       "user_id": 1,
       "user_group": "第1组",
       "remark": "测试资产"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的资产信息
  - 资产历史记录中创建了创建记录

#### TC-ASSET-014: 普通用户创建资产
- **测试步骤**:
  1. 发送POST请求到 `/api/assets/`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体: 同上（但不包含user_id）
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的资产信息
  - 资产自动归属到当前用户

#### TC-ASSET-015: 创建重复资产编号的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/assets/`
  2. 请求体: 使用已存在的资产编号
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "资产编号已存在"}`

#### TC-ASSET-016: 创建资产时指定不存在的大类
- **测试步骤**:
  1. 发送POST请求到 `/api/assets/`
  2. 请求体: `{"category_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "资产大类不存在"}`

#### TC-ASSET-017: 创建资产时指定不存在的使用人
- **测试步骤**:
  1. 发送POST请求到 `/api/assets/`
  2. 请求体: `{"user_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "使用人不存在"}`

### 5.4 更新资产

#### TC-ASSET-018: 管理员直接更新资产
- **测试步骤**:
  1. 发送PUT请求到 `/api/assets/1`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 请求体: `{"name": "新名称", "specification": "新规格"}`
- **预期结果**: 
  - 状态码: 200
  - 返回更新后的资产信息
  - 资产历史记录中创建了编辑记录

#### TC-ASSET-019: 普通用户更新自己的资产（提交编辑申请）
- **前置条件**: 资产属于当前用户
- **测试步骤**:
  1. 发送PUT请求到 `/api/assets/{asset_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体: `{"name": "新名称"}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"message": "编辑申请已提交，等待管理员审批", "edit_request_id": N}`
  - 创建了编辑申请记录

#### TC-ASSET-020: 普通用户尝试更新他人的资产
- **测试步骤**:
  1. 发送PUT请求到 `/api/assets/{other_user_asset_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只能编辑自己名下的资产"}`

#### TC-ASSET-021: 普通用户尝试修改使用人
- **测试步骤**:
  1. 发送PUT请求到 `/api/assets/{asset_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体: `{"user_id": 2}` (修改为其他用户)
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "普通用户不能修改资产使用人"}`

#### TC-ASSET-022: 更新不存在的资产
- **测试步骤**:
  1. 发送PUT请求到 `/api/assets/99999`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "资产不存在"}`

### 5.5 删除资产（仅管理员，软删除）

#### TC-ASSET-023: 管理员删除资产
- **测试步骤**:
  1. 发送DELETE请求到 `/api/assets/1`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"message": "资产已删除"}`
  - 资产被软删除（deleted_at不为空）
  - 资产历史记录中创建了删除记录

#### TC-ASSET-024: 普通用户尝试删除资产
- **测试步骤**:
  1. 发送DELETE请求到 `/api/assets/1`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只有管理员可以删除资产"}`

#### TC-ASSET-025: 删除已删除的资产
- **测试步骤**:
  1. 发送DELETE请求到 `/api/assets/{deleted_asset_id}`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "资产已被删除"}`

### 5.6 批量导入资产（仅管理员）

#### TC-ASSET-026: 正确格式的Excel导入
- **测试步骤**:
  1. 发送POST请求到 `/api/assets/import`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 上传包含正确格式的Excel文件
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"success_count": N, "error_count": 0, "errors": []}`

#### TC-ASSET-027: 缺少必需列的Excel导入
- **测试步骤**:
  1. 上传缺少"资产编号"列的Excel文件
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "Excel文件缺少必需的列：资产编号"}`

#### TC-ASSET-028: 包含重复资产编号的Excel导入
- **测试步骤**:
  1. 上传包含重复资产编号的Excel文件
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"success_count": N, "error_count": M, "errors": ["第X行：资产编号已存在", ...]}`

#### TC-ASSET-029: 包含不存在使用人EHR号的Excel导入
- **测试步骤**:
  1. 上传包含不存在EHR号的Excel文件
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"success_count": N, "error_count": M, "errors": ["第X行：使用人EHR号不存在", ...]}`

### 5.7 导出资产（仅管理员）

#### TC-ASSET-030: 导出所有资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/export`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回Excel文件流
  - Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`

#### TC-ASSET-031: 导出指定资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/export?asset_ids=1,2,3`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含指定资产的Excel文件

#### TC-ASSET-032: 普通用户尝试导出资产
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/export`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只有管理员可以导出资产"}`

---

## 6. 资产交接模块测试

### 6.1 获取交接申请列表

#### TC-TRANSFER-001: 获取所有交接申请（管理员）
- **测试步骤**:
  1. 发送GET请求到 `/api/transfers/`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回所有交接申请列表

#### TC-TRANSFER-002: 普通用户获取交接申请列表
- **测试步骤**:
  1. 发送GET请求到 `/api/transfers/`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回与自己相关的交接申请（转出或转入）

#### TC-TRANSFER-003: 按状态筛选交接申请
- **测试步骤**:
  1. 发送GET请求到 `/api/transfers/?status=pending`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回状态为"pending"的交接申请

#### TC-TRANSFER-004: 搜索交接申请
- **测试步骤**:
  1. 发送GET请求到 `/api/transfers/?search=笔记本电脑`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含搜索关键词的交接申请

### 6.2 获取指定交接申请

#### TC-TRANSFER-005: 获取存在的交接申请
- **测试步骤**:
  1. 发送GET请求到 `/api/transfers/1`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回交接申请详细信息

#### TC-TRANSFER-006: 普通用户查看他人的交接申请
- **测试步骤**:
  1. 发送GET请求到 `/api/transfers/{other_user_request_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "无权查看此申请"}`

### 6.3 创建交接申请

#### TC-TRANSFER-007: 创建交接申请
- **前置条件**: 资产状态为"在用"，属于当前用户
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体:
     ```json
     {
       "asset_id": 1,
       "to_user_id": 2,
       "reason": "工作调动"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的交接申请
  - 申请状态为"pending"
  - 资产历史记录中创建了交接申请记录

#### TC-TRANSFER-008: 交接不存在的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求体: `{"asset_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "资产不存在"}`

#### TC-TRANSFER-009: 交接非"在用"状态的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求体: 资产状态为"库存备用"
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "只能交接在用状态的资产"}`

#### TC-TRANSFER-010: 普通用户交接他人的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求体: 资产不属于当前用户
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只能交接自己名下的资产"}`

#### TC-TRANSFER-011: 交接给仓库用户
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求体: `{"to_user_id": warehouse_user_id}` (EHR号为1000000)
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "不能将资产交接给仓库用户"}`

#### TC-TRANSFER-012: 交接给自己
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求体: `{"to_user_id": current_user_id}` (转出用户和转入用户相同)
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "不能将资产转给自己"}`

#### TC-TRANSFER-013: 交接给不存在的用户
- **测试步骤**:
  1. 发送POST请求到 `/api/transfers/`
  2. 请求体: `{"to_user_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "转入用户不存在"}`

### 6.4 撤回交接申请

#### TC-TRANSFER-014: 撤回待审批的交接申请
- **前置条件**: 申请状态为"pending"，当前用户是申请创建人
- **测试步骤**:
  1. 发送DELETE请求到 `/api/transfers/1`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"message": "申请已撤回"}`
  - 申请被删除
  - 资产历史记录中创建了撤回记录

#### TC-TRANSFER-015: 撤回已处理的申请
- **测试步骤**:
  1. 发送DELETE请求到 `/api/transfers/{approved_request_id}`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "只能撤回待审批状态的申请"}`

#### TC-TRANSFER-016: 他人尝试撤回申请
- **测试步骤**:
  1. 发送DELETE请求到 `/api/transfers/{other_user_request_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只有申请创建人可以撤回申请"}`

---

## 7. 资产退回模块测试

### 7.1 获取退回申请列表

#### TC-RETURN-001: 获取所有退回申请（管理员）
- **测试步骤**:
  1. 发送GET请求到 `/api/returns/`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回所有退回申请列表

#### TC-RETURN-002: 普通用户获取退回申请列表
- **测试步骤**:
  1. 发送GET请求到 `/api/returns/`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回自己的退回申请

#### TC-RETURN-003: 按状态筛选退回申请
- **测试步骤**:
  1. 发送GET请求到 `/api/returns/?status=pending`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回状态为"pending"的退回申请

#### TC-RETURN-004: 搜索退回申请
- **测试步骤**:
  1. 发送GET请求到 `/api/returns/?search=笔记本电脑`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含搜索关键词的退回申请

### 7.2 获取指定退回申请

#### TC-RETURN-005: 获取存在的退回申请
- **测试步骤**:
  1. 发送GET请求到 `/api/returns/1`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回退回申请详细信息

#### TC-RETURN-006: 普通用户查看他人的退回申请
- **测试步骤**:
  1. 发送GET请求到 `/api/returns/{other_user_request_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "无权查看此申请"}`

### 7.3 创建退回申请

#### TC-RETURN-007: 创建退回申请（不修改字段）
- **前置条件**: 资产状态为"在用"，属于当前用户
- **测试步骤**:
  1. 发送POST请求到 `/api/returns/`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体:
     ```json
     {
       "asset_id": 1,
       "reason": "不再使用"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的退回申请
  - 申请状态为"pending"
  - 资产历史记录中创建了退回申请记录

#### TC-RETURN-008: 创建退回申请（修改字段）
- **测试步骤**:
  1. 发送POST请求到 `/api/returns/`
  2. 请求体:
     ```json
     {
       "asset_id": 1,
       "reason": "不再使用",
       "mac_address": "00:11:22:33:44:66",
       "ip_address": "192.168.1.101",
       "office_location": "仓库A",
       "floor": "1楼",
       "seat_number": "W01",
       "new_user_id": 3,
       "remark": "退回时更新信息"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的退回申请
  - 申请中保存了修改的字段

#### TC-RETURN-009: 退回不存在的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/returns/`
  2. 请求体: `{"asset_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "资产不存在"}`

#### TC-RETURN-010: 退回非"在用"状态的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/returns/`
  2. 请求体: 资产状态为"库存备用"
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "只能退回在用状态的资产"}`

#### TC-RETURN-011: 普通用户退回他人的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/returns/`
  2. 请求体: 资产不属于当前用户
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只能退回自己名下的资产"}`

#### TC-RETURN-012: 指定不存在的保管人
- **测试步骤**:
  1. 发送POST请求到 `/api/returns/`
  2. 请求体: `{"new_user_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "指定的保管人不存在"}`

---

## 8. 审批管理模块测试

### 8.1 审批交接申请

#### TC-APPROVAL-001: 批准交接申请
- **前置条件**: 已使用管理员账号登录，存在待审批的交接申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求头: `Authorization: Bearer {admin_token}`
  3. 请求体:
     ```json
     {
       "request_type": "transfer",
       "request_id": 1,
       "approved": true,
       "comment": "同意交接"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"message": "审批完成"}`
  - 申请状态更新为"approved"
  - 资产的使用人更新为转入用户
  - 资产历史记录中创建了审批通过记录

#### TC-APPROVAL-002: 拒绝交接申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: `{"approved": false, ...}`
- **预期结果**: 
  - 状态码: 200
  - 返回: `{"message": "审批完成"}`
  - 申请状态更新为"rejected"
  - 资产信息不变
  - 资产历史记录中创建了审批拒绝记录

#### TC-APPROVAL-003: 普通用户尝试审批
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只有管理员可以执行此操作"}`

#### TC-APPROVAL-004: 审批已处理的申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: 申请状态不是"pending"
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "该申请已处理"}`

#### TC-APPROVAL-005: 审批不存在的申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: `{"request_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "交接申请不存在"}`

### 8.2 审批退回申请

#### TC-APPROVAL-006: 批准退回申请（情况1：修改了保管人）
- **前置条件**: 退回申请中指定了new_user_id
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体:
     ```json
     {
       "request_type": "return",
       "request_id": 1,
       "approved": true,
       "comment": "同意退回"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 资产状态变为"库存备用"
  - 资产使用人更新为new_user_id
  - 其他字段按申请人修改的内容更新

#### TC-APPROVAL-007: 批准退回申请（情况2：未修改保管人但修改了其他字段）
- **前置条件**: 退回申请中未指定new_user_id但修改了其他字段
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: 同上
- **预期结果**: 
  - 状态码: 200
  - 资产状态变为"库存备用"
  - 资产使用人更新为仓库用户（EHR号1000000）
  - 其他字段按申请人修改的内容更新

#### TC-APPROVAL-008: 批准退回申请（情况3：未修改任何字段）
- **前置条件**: 退回申请中未修改任何字段
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: 同上
- **预期结果**: 
  - 状态码: 200
  - 资产状态变为"库存备用"
  - 资产使用人更新为仓库用户
  - 其他字段保持不变

#### TC-APPROVAL-009: 拒绝退回申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: `{"approved": false, ...}`
- **预期结果**: 
  - 状态码: 200
  - 申请状态更新为"rejected"
  - 资产信息不变

### 8.3 审批编辑申请

#### TC-APPROVAL-010: 批准编辑申请
- **前置条件**: 存在待审批的编辑申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体:
     ```json
     {
       "request_type": "edit",
       "request_id": 1,
       "approved": true,
       "comment": "同意编辑"
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 申请状态更新为"approved"
  - 资产信息按编辑申请中的内容更新
  - 资产历史记录中创建了审批通过记录

#### TC-APPROVAL-011: 拒绝编辑申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: `{"approved": false, ...}`
- **预期结果**: 
  - 状态码: 200
  - 申请状态更新为"rejected"
  - 资产信息不变

#### TC-APPROVAL-012: 审批不存在的编辑申请
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: `{"request_type": "edit", "request_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "编辑申请不存在"}`

#### TC-APPROVAL-013: 无效的申请类型
- **测试步骤**:
  1. 发送POST请求到 `/api/approvals/approve`
  2. 请求体: `{"request_type": "invalid", ...}`
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "无效的申请类型"}`

---

## 9. 资产编辑申请模块测试

### 9.1 获取编辑申请列表

#### TC-EDIT-001: 获取所有编辑申请（管理员）
- **测试步骤**:
  1. 发送GET请求到 `/api/edit-requests/`
  2. 请求头: `Authorization: Bearer {admin_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回所有编辑申请列表

#### TC-EDIT-002: 普通用户获取编辑申请列表
- **测试步骤**:
  1. 发送GET请求到 `/api/edit-requests/`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 200
  - 返回自己的编辑申请

#### TC-EDIT-003: 按状态筛选编辑申请
- **测试步骤**:
  1. 发送GET请求到 `/api/edit-requests/?status=pending`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回状态为"pending"的编辑申请

#### TC-EDIT-004: 搜索编辑申请
- **测试步骤**:
  1. 发送GET请求到 `/api/edit-requests/?search=笔记本电脑`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回包含搜索关键词的编辑申请

### 9.2 获取指定编辑申请

#### TC-EDIT-005: 获取存在的编辑申请
- **测试步骤**:
  1. 发送GET请求到 `/api/edit-requests/1`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回编辑申请详细信息（包含edit_data）

#### TC-EDIT-006: 普通用户查看他人的编辑申请
- **测试步骤**:
  1. 发送GET请求到 `/api/edit-requests/{other_user_request_id}`
  2. 请求头: `Authorization: Bearer {user_token}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "无权查看此申请"}`

### 9.3 创建编辑申请

#### TC-EDIT-007: 创建编辑申请
- **前置条件**: 资产属于当前用户
- **测试步骤**:
  1. 发送POST请求到 `/api/edit-requests/`
  2. 请求头: `Authorization: Bearer {user_token}`
  3. 请求体:
     ```json
     {
       "asset_id": 1,
       "edit_data": {
         "name": "新名称",
         "specification": "新规格",
         "mac_address": "00:11:22:33:44:77"
       }
     }
     ```
- **预期结果**: 
  - 状态码: 200
  - 返回新创建的编辑申请
  - 申请状态为"pending"
  - 资产历史记录中创建了编辑申请记录

#### TC-EDIT-008: 编辑不存在的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/edit-requests/`
  2. 请求体: `{"asset_id": 99999, ...}`
- **预期结果**: 
  - 状态码: 404
  - 返回: `{"detail": "资产不存在"}`

#### TC-EDIT-009: 普通用户编辑他人的资产
- **测试步骤**:
  1. 发送POST请求到 `/api/edit-requests/`
  2. 请求体: 资产不属于当前用户
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "只能编辑自己名下的资产"}`

#### TC-EDIT-010: 普通用户尝试修改使用人
- **测试步骤**:
  1. 发送POST请求到 `/api/edit-requests/`
  2. 请求体: `{"edit_data": {"user_id": 2}, ...}`
- **预期结果**: 
  - 状态码: 403
  - 返回: `{"detail": "普通用户不能修改资产使用人"}`

---

## 10. 统计信息模块测试

### 10.1 获取系统统计

#### TC-STATS-001: 获取系统统计数据
- **测试步骤**:
  1. 发送GET请求到 `/api/stats/`
  2. 请求头: `Authorization: Bearer {token}`
- **预期结果**: 
  - 状态码: 200
  - 返回:
     ```json
     {
       "total_users": 10,
       "total_assets": 50,
       "in_use_assets": 30,
       "pending_approvals": 5
     }
     ```

#### TC-STATS-002: 未登录获取统计信息
- **测试步骤**:
  1. 发送GET请求到 `/api/stats/`
  2. 不提供Authorization头
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "未认证"}`

---

## 11. 边界测试

### 11.1 分页边界

#### TC-BOUNDARY-001: skip为负数
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?skip=-1`
- **预期结果**: 
  - 状态码: 422 (验证错误)

#### TC-BOUNDARY-002: limit为0
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?limit=0`
- **预期结果**: 
  - 状态码: 422 (验证错误) 或 200（返回空列表）

#### TC-BOUNDARY-003: limit过大
- **测试步骤**:
  1. 发送GET请求到 `/api/assets/?limit=10000`
- **预期结果**: 
  - 状态码: 200
  - 返回最多100条记录（默认限制）

### 11.2 字符串长度边界

#### TC-BOUNDARY-004: EHR号长度边界
- **测试步骤**:
  1. 创建用户，EHR号为6位或8位
- **预期结果**: 
  - 状态码: 422 (验证错误)

#### TC-BOUNDARY-005: 超长字符串
- **测试步骤**:
  1. 创建资产，名称字段输入超长字符串（如1000个字符）
- **预期结果**: 
  - 状态码: 422 (验证错误) 或 200（如果数据库允许）

### 11.3 空值和null值

#### TC-BOUNDARY-006: 必填字段为空
- **测试步骤**:
  1. 创建资产，不提供asset_number
- **预期结果**: 
  - 状态码: 422 (验证错误)

#### TC-BOUNDARY-007: 可选字段为null
- **测试步骤**:
  1. 创建资产，specification字段为null
- **预期结果**: 
  - 状态码: 200
  - 资产创建成功，specification为null

---

## 12. 异常测试

### 12.1 Token相关异常

#### TC-EXCEPTION-001: 无效的Token
- **测试步骤**:
  1. 发送请求，Authorization头为无效token
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "无效的token"}`

#### TC-EXCEPTION-002: 过期的Token
- **测试步骤**:
  1. 发送请求，使用已过期的token
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "token已过期"}`

#### TC-EXCEPTION-003: 缺少Token
- **测试步骤**:
  1. 发送需要认证的请求，不提供Authorization头
- **预期结果**: 
  - 状态码: 401
  - 返回: `{"detail": "未认证"}`

### 12.2 数据库异常

#### TC-EXCEPTION-004: 并发创建相同资产编号
- **测试步骤**:
  1. 同时发送两个创建相同资产编号的请求
- **预期结果**: 
  - 其中一个成功，另一个返回400错误

### 12.3 文件上传异常

#### TC-EXCEPTION-005: 上传非Excel文件
- **测试步骤**:
  1. 上传.txt文件到导入接口
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "文件格式错误"}`

#### TC-EXCEPTION-006: 上传空文件
- **测试步骤**:
  1. 上传空的Excel文件
- **预期结果**: 
  - 状态码: 400
  - 返回: `{"detail": "文件为空"}`

#### TC-EXCEPTION-007: 上传超大文件
- **测试步骤**:
  1. 上传超过限制大小的Excel文件（如100MB）
- **预期结果**: 
  - 状态码: 413 或 400
  - 返回文件大小超限错误

---

## 13. 权限测试总结

### 13.1 管理员权限
- ✅ 可以执行所有操作
- ✅ 可以查看所有用户和资产
- ✅ 可以管理用户（增删改查、批量导入）
- ✅ 可以直接更新资产（无需审批）
- ✅ 可以删除资产（软删除）
- ✅ 可以审批所有申请
- ✅ 可以导出资产

### 13.2 普通用户权限
- ✅ 可以查看用户列表（用于选择）
- ✅ 可以查看自己的资产
- ❌ 不能查看他人的资产
- ✅ 可以创建资产（自动归属自己）
- ✅ 可以编辑自己的资产（需提交申请）
- ❌ 不能直接更新资产（需审批）
- ❌ 不能删除资产
- ❌ 不能审批申请
- ✅ 可以创建交接申请（自己的资产）
- ✅ 可以创建退回申请（自己的资产）
- ✅ 可以创建编辑申请（自己的资产）
- ✅ 可以撤回自己的待审批申请

---

## 14. 测试执行记录

### 14.1 测试环境准备
- [ ] 搭建测试环境
- [ ] 初始化测试数据
- [ ] 准备测试账号

### 14.2 测试执行
- [ ] 认证模块测试
- [ ] 用户管理模块测试
- [ ] 资产大类管理模块测试
- [ ] 资产管理模块测试
- [ ] 资产交接模块测试
- [ ] 资产退回模块测试
- [ ] 审批管理模块测试
- [ ] 资产编辑申请模块测试
- [ ] 统计信息模块测试
- [ ] 边界测试
- [ ] 异常测试

### 14.3 缺陷记录
| 缺陷ID | 模块 | 测试用例 | 缺陷描述 | 严重程度 | 状态 |
|--------|------|----------|----------|----------|------|
| BUG-001 | - | - | - | - | - |

---

## 15. 测试总结

### 15.1 测试覆盖率
- **功能覆盖率**: 100%
- **接口覆盖率**: 100%
- **权限测试覆盖率**: 100%

### 15.2 测试结果统计
- **总测试用例数**: 150+
- **通过**: -
- **失败**: -
- **阻塞**: -

### 15.3 风险评估
- **高风险功能**: 审批流程、资产交接、资产退回
- **中风险功能**: 批量导入、资产删除
- **低风险功能**: 查询、统计

---

## 附录

### A. API端点清单

#### 认证模块
- `POST /api/auth/check-ehr` - 检查EHR号
- `POST /api/auth/login` - 用户登录

#### 用户管理
- `GET /api/users/` - 获取用户列表
- `GET /api/users/me` - 获取当前用户信息
- `GET /api/users/{id}` - 获取指定用户
- `POST /api/users/` - 创建用户（管理员）
- `PUT /api/users/{id}` - 更新用户（管理员）
- `DELETE /api/users/{id}` - 删除用户（管理员）
- `POST /api/users/import` - 批量导入用户（管理员）

#### 资产大类
- `GET /api/categories/` - 获取资产大类列表
- `POST /api/categories/` - 创建资产大类

#### 资产管理
- `GET /api/assets/` - 获取资产列表
- `GET /api/assets/export` - 导出资产（管理员）
- `GET /api/assets/{id}` - 获取指定资产
- `POST /api/assets/` - 创建资产
- `PUT /api/assets/{id}` - 更新资产
- `DELETE /api/assets/{id}` - 删除资产（管理员）
- `POST /api/assets/import` - 批量导入资产（管理员）

#### 资产交接
- `GET /api/transfers/` - 获取交接申请列表
- `GET /api/transfers/{id}` - 获取指定交接申请
- `POST /api/transfers/` - 创建交接申请
- `DELETE /api/transfers/{id}` - 撤回交接申请

#### 资产退回
- `GET /api/returns/` - 获取退回申请列表
- `GET /api/returns/{id}` - 获取指定退回申请
- `POST /api/returns/` - 创建退回申请

#### 审批管理
- `POST /api/approvals/approve` - 审批申请（管理员）

#### 资产编辑申请
- `GET /api/edit-requests/` - 获取编辑申请列表
- `GET /api/edit-requests/{id}` - 获取指定编辑申请
- `POST /api/edit-requests/` - 创建编辑申请

#### 统计信息
- `GET /api/stats/` - 获取系统统计数据

### B. 测试数据准备

#### 测试用户
- 管理员: EHR号 1000000, 密码 admin123
- 普通用户1: EHR号 1234567, 密码 user123
- 普通用户2: EHR号 2345678, 密码 user123
- 仓库用户: EHR号 1000000 (系统内置)

#### 测试资产大类
- 办公用品
- 电子设备配件
- 家具设备

#### 测试资产
- 资产编号: ASSET001, 状态: 在用, 使用人: 用户1
- 资产编号: ASSET002, 状态: 库存备用, 使用人: 仓库
- 资产编号: ASSET003, 状态: 在用, 使用人: 用户2

### C. 测试工具推荐
- **API测试**: Postman, Insomnia, curl
- **自动化测试**: pytest, pytest-asyncio
- **性能测试**: Apache JMeter, Locust
- **安全测试**: OWASP ZAP

---

**文档结束**

