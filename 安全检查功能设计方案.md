# 安全检查功能设计方案

## 一、需求分析

### 1.1 功能概述
- 管理员可以筛选资产，选择检查类型，发布安全检查任务
- 任务自动分配给资产的使用人（普通用户）
- 普通用户收到任务后，完成检查并在系统上确认结果
- 检查类型可以动态管理（会变化）

### 1.2 核心需求
1. **检查类型管理**：支持动态添加、编辑检查类型
2. **任务发布**：管理员批量选择资产，选择检查类型，发布任务
3. **任务分配**：任务自动分配给资产的使用人
4. **任务执行**：普通用户查看任务，确认检查结果
5. **历史记录**：记录所有检查历史

---

## 二、数据库结构设计

### 2.1 检查类型表（safety_check_types）

**表名**：`safety_check_types`

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Integer | 主键 | 自增 |
| name | String(100) | 检查类型名称 | 唯一，非空 |
| description | Text | 检查类型描述 | 可空 |
| check_items | Text | 检查项列表（JSON格式） | 可空 |
| is_active | Boolean | 是否启用 | 默认True |
| created_at | DateTime | 创建时间 | 自动 |
| updated_at | DateTime | 更新时间 | 自动 |
| created_by_id | Integer | 创建人ID | 外键，可空 |

**设计说明**：
- `name`：检查类型名称，如"消防安全检查"、"电气安全检查"、"设备安全检查"等
- `check_items`：JSON格式存储检查项列表，例如：
  ```json
  [
    {"item": "电源线是否完好", "required": true},
    {"item": "设备外观是否正常", "required": true},
    {"item": "安全标识是否清晰", "required": false}
  ]
  ```
- `is_active`：支持停用某个检查类型，已停用的类型不能用于新建任务

### 2.2 安全检查任务表（safety_check_tasks）

**表名**：`safety_check_tasks`

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Integer | 主键 | 自增 |
| task_number | String(50) | 任务编号 | 唯一，非空 |
| check_type_id | Integer | 检查类型ID | 外键，非空 |
| title | String(200) | 任务标题 | 非空 |
| description | Text | 任务描述 | 可空 |
| deadline | DateTime | 截止时间 | 可空 |
| status | String(20) | 任务状态 | 非空，默认pending |
| created_by_id | Integer | 创建人ID | 外键，非空 |
| created_at | DateTime | 创建时间 | 自动 |
| updated_at | DateTime | 更新时间 | 自动 |
| completed_at | DateTime | 完成时间 | 可空 |

**任务状态枚举**：
- `pending`：进行中（有未完成的检查项）
- `completed`：已完成（所有检查项都已完成）
- `overdue`：已逾期（超过截止时间未完成）
- `cancelled`：已取消

**设计说明**：
- `task_number`：任务编号，格式如"SAFETY-2025-001"，便于追踪
- `deadline`：可选，如果设置了截止时间，系统可以标记逾期任务
- `status`：任务整体状态，根据所有检查项的状态自动计算

### 2.3 任务资产关联表（task_assets）

**表名**：`task_assets`

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Integer | 主键 | 自增 |
| task_id | Integer | 任务ID | 外键，非空 |
| asset_id | Integer | 资产ID | 外键，非空 |
| assigned_user_id | Integer | 分配用户ID（资产使用人） | 外键，非空 |
| status | String(20) | 检查状态 | 非空，默认pending |
| check_result | String(20) | 检查结果 | 可空 |
| check_comment | Text | 检查备注 | 可空 |
| check_items_result | Text | 检查项结果（JSON格式） | 可空 |
| checked_at | DateTime | 检查时间 | 可空 |
| created_at | DateTime | 创建时间 | 自动 |
| updated_at | DateTime | 更新时间 | 自动 |

**检查状态枚举**：
- `pending`：待检查
- `checked`：已检查
- `overdue`：已逾期

**检查结果枚举**：
- `pass`：通过
- `fail`：不通过
- `warning`：警告（需要关注但不算不通过）

**设计说明**：
- `assigned_user_id`：自动从资产的使用人获取，如果资产没有使用人，可以分配给管理员或标记为待分配
- `check_items_result`：JSON格式存储每个检查项的结果，例如：
  ```json
  [
    {"item": "电源线是否完好", "result": "pass", "comment": "正常"},
    {"item": "设备外观是否正常", "result": "pass", "comment": "正常"},
    {"item": "安全标识是否清晰", "result": "warning", "comment": "标识略有磨损"}
  ]
  ```
- 一个任务可以包含多个资产，一个资产在一个任务中只有一条记录

### 2.4 检查历史记录表（safety_check_history）

**表名**：`safety_check_history`

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | Integer | 主键 | 自增 |
| task_id | Integer | 任务ID | 外键，非空 |
| task_asset_id | Integer | 任务资产关联ID | 外键，非空 |
| asset_id | Integer | 资产ID | 外键，非空 |
| check_type_id | Integer | 检查类型ID | 外键，非空 |
| checked_by_id | Integer | 检查人ID | 外键，非空 |
| check_result | String(20) | 检查结果 | 非空 |
| check_comment | Text | 检查备注 | 可空 |
| check_items_result | Text | 检查项结果（JSON） | 可空 |
| checked_at | DateTime | 检查时间 | 非空 |
| created_at | DateTime | 创建时间 | 自动 |

**设计说明**：
- 每次检查完成后，创建一条历史记录
- 历史记录不可修改，用于审计和追溯
- 可以查询某个资产的所有检查历史

### 2.5 数据库关系图

```
safety_check_types (检查类型)
    ↓ (一对多)
safety_check_tasks (任务)
    ↓ (一对多)
task_assets (任务资产关联)
    ↓ (多对一)
assets (资产)
    ↓ (多对一)
users (用户 - 资产使用人)

safety_check_history (检查历史)
    ↓ (多对一)
task_assets (任务资产关联)
```

---

## 三、后端实现方案

### 3.1 目录结构

```
backend/
├── routers/
│   ├── safety_check_types.py    # 检查类型管理路由
│   ├── safety_check_tasks.py    # 任务管理路由
│   └── safety_check_results.py   # 检查结果提交路由
├── models.py                     # 添加新的数据模型
└── schemas.py                    # 添加新的Pydantic模式
```

### 3.2 API接口设计

#### 3.2.1 检查类型管理接口（safety_check_types.py）

**权限**：仅管理员

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/safety-check-types/` | 获取检查类型列表 |
| GET | `/api/safety-check-types/{id}` | 获取指定检查类型 |
| POST | `/api/safety-check-types/` | 创建检查类型 |
| PUT | `/api/safety-check-types/{id}` | 更新检查类型 |
| DELETE | `/api/safety-check-types/{id}` | 删除检查类型（软删除） |

**关键接口说明**：

**创建检查类型**：
```python
POST /api/safety-check-types/
{
  "name": "消防安全检查",
  "description": "检查消防设备是否正常",
  "check_items": [
    {"item": "灭火器是否在有效期内", "required": true},
    {"item": "消防通道是否畅通", "required": true},
    {"item": "烟雾报警器是否正常", "required": false}
  ]
}
```

**响应**：
```json
{
  "id": 1,
  "name": "消防安全检查",
  "description": "检查消防设备是否正常",
  "check_items": [...],
  "is_active": true,
  "created_at": "2025-01-01T10:00:00",
  "created_by": {"id": 1, "real_name": "管理员"}
}
```

#### 3.2.2 任务管理接口（safety_check_tasks.py）

**权限**：
- 创建任务：仅管理员
- 查看任务：管理员查看所有，普通用户查看分配给自己的

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/api/safety-check-tasks/` | 获取任务列表 | 管理员/普通用户 |
| GET | `/api/safety-check-tasks/{id}` | 获取任务详情 | 管理员/普通用户 |
| POST | `/api/safety-check-tasks/` | 创建任务 | 仅管理员 |
| PUT | `/api/safety-check-tasks/{id}` | 更新任务 | 仅管理员 |
| DELETE | `/api/safety-check-tasks/{id}` | 取消任务 | 仅管理员 |
| GET | `/api/safety-check-tasks/{id}/assets` | 获取任务资产列表 | 管理员/普通用户 |

**关键接口说明**：

**创建任务**：
```python
POST /api/safety-check-tasks/
{
  "check_type_id": 1,
  "title": "2025年第一季度消防安全检查",
  "description": "对所有在用资产进行消防安全检查",
  "asset_ids": [1, 2, 3, 4, 5],  # 资产ID列表
  "deadline": "2025-03-31T23:59:59"  # 可选
}
```

**处理逻辑**：
1. 验证检查类型是否存在且启用
2. 验证资产是否存在且未删除
3. 生成任务编号（格式：SAFETY-YYYY-NNN）
4. 创建任务记录
5. 为每个资产创建任务资产关联记录：
   - 自动获取资产的使用人作为分配用户
   - 如果资产没有使用人，可以：
     a. 跳过该资产（不加入任务）
     b. 分配给管理员
     c. 标记为待分配
6. 返回任务详情

**获取任务列表**：
```python
GET /api/safety-check-tasks/?status=pending&page=1&limit=20
```

**响应**（管理员）：
```json
{
  "total": 10,
  "items": [
    {
      "id": 1,
      "task_number": "SAFETY-2025-001",
      "title": "2025年第一季度消防安全检查",
      "check_type": {"id": 1, "name": "消防安全检查"},
      "status": "pending",
      "total_assets": 50,
      "completed_assets": 30,
      "pending_assets": 20,
      "deadline": "2025-03-31T23:59:59",
      "created_by": {"id": 1, "real_name": "管理员"},
      "created_at": "2025-01-01T10:00:00"
    }
  ]
}
```

**响应**（普通用户）：
```json
{
  "total": 3,
  "items": [
    {
      "id": 1,
      "task_number": "SAFETY-2025-001",
      "title": "2025年第一季度消防安全检查",
      "check_type": {"id": 1, "name": "消防安全检查"},
      "my_assets_count": 5,  # 分配给当前用户的资产数量
      "my_completed_count": 2,  # 当前用户已完成的资产数量
      "deadline": "2025-03-31T23:59:59"
    }
  ]
}
```

#### 3.2.3 检查结果提交接口（safety_check_results.py）

**权限**：普通用户（只能提交分配给自己的任务）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/safety-check-results/my-tasks` | 获取我的待检查任务 |
| GET | `/api/safety-check-results/task/{task_id}/assets` | 获取任务中分配给当前用户的资产 |
| POST | `/api/safety-check-results/submit` | 提交检查结果 |
| GET | `/api/safety-check-results/asset/{asset_id}/history` | 获取资产检查历史 |

**关键接口说明**：

**获取我的待检查任务**：
```python
GET /api/safety-check-results/my-tasks?status=pending
```

**响应**：
```json
{
  "total": 5,
  "items": [
    {
      "task_id": 1,
      "task_number": "SAFETY-2025-001",
      "task_title": "2025年第一季度消防安全检查",
      "check_type": {"id": 1, "name": "消防安全检查", "check_items": [...]},
      "pending_count": 3,  # 待检查的资产数量
      "deadline": "2025-03-31T23:59:59"
    }
  ]
}
```

**获取任务资产列表**：
```python
GET /api/safety-check-results/task/1/assets
```

**响应**：
```json
{
  "task": {
    "id": 1,
    "task_number": "SAFETY-2025-001",
    "title": "2025年第一季度消防安全检查",
    "check_type": {
      "id": 1,
      "name": "消防安全检查",
      "check_items": [
        {"item": "灭火器是否在有效期内", "required": true},
        {"item": "消防通道是否畅通", "required": true}
      ]
    },
    "deadline": "2025-03-31T23:59:59"
  },
  "assets": [
    {
      "task_asset_id": 1,
      "asset": {
        "id": 1,
        "asset_number": "ASSET001",
        "name": "主机",
        "office_location": "办公楼A",
        "floor": "3F"
      },
      "status": "pending",
      "check_result": null,
      "check_comment": null
    }
  ]
}
```

**提交检查结果**：
```python
POST /api/safety-check-results/submit
{
  "task_asset_id": 1,  # 任务资产关联ID
  "check_result": "pass",  # pass/fail/warning
  "check_comment": "检查正常，所有项目合格",
  "check_items_result": [
    {
      "item": "灭火器是否在有效期内",
      "result": "pass",
      "comment": "有效期至2025-12-31"
    },
    {
      "item": "消防通道是否畅通",
      "result": "pass",
      "comment": "通道畅通"
    }
  ]
}
```

**处理逻辑**：
1. 验证任务资产关联是否存在
2. 验证是否分配给当前用户
3. 验证任务是否已完成或已取消
4. 更新任务资产关联记录：
   - 设置status为"checked"
   - 保存检查结果和备注
   - 保存检查项结果
   - 记录检查时间
5. 创建检查历史记录
6. 更新任务状态（如果所有资产都已完成，任务状态改为"completed"）
7. 返回成功响应

**获取资产检查历史**：
```python
GET /api/safety-check-results/asset/1/history?page=1&limit=20
```

**响应**：
```json
{
  "total": 10,
  "items": [
    {
      "id": 1,
      "task_number": "SAFETY-2025-001",
      "check_type": {"id": 1, "name": "消防安全检查"},
      "check_result": "pass",
      "check_comment": "检查正常",
      "checked_by": {"id": 2, "real_name": "张三"},
      "checked_at": "2025-01-15T10:30:00"
    }
  ]
}
```

### 3.3 业务逻辑设计

#### 3.3.1 任务创建流程

```
1. 管理员选择检查类型
2. 筛选资产（支持多条件筛选）
3. 选择资产（支持批量选择）
4. 设置任务信息（标题、描述、截止时间）
5. 提交创建任务
6. 系统处理：
   a. 生成任务编号
   b. 创建任务记录
   c. 为每个资产创建任务资产关联记录
   d. 自动分配用户（资产使用人）
   e. 如果资产没有使用人，标记为待分配或跳过
7. 返回任务详情
```

#### 3.3.2 任务分配逻辑

**分配规则**：
1. 优先分配给资产的使用人（user_id）
2. 如果资产没有使用人（user_id为null）：
   - 方案A：跳过该资产，不加入任务（推荐）
   - 方案B：分配给任务创建人（管理员）
   - 方案C：标记为待分配，管理员手动分配
3. 如果资产使用人已离职或被删除：
   - 标记为待分配，管理员手动重新分配

#### 3.3.3 任务状态计算

**任务状态自动计算规则**：
- `pending`：存在status为"pending"的任务资产关联
- `completed`：所有任务资产关联的status都是"checked"
- `overdue`：存在超过deadline且status为"pending"的任务资产关联
- `cancelled`：管理员手动取消

#### 3.3.4 检查结果验证

**验证规则**：
1. 必填检查项必须填写结果
2. 检查结果必须是：pass/fail/warning
3. 如果检查结果为fail，建议填写详细备注
4. 检查时间不能早于任务创建时间

### 3.4 数据模型代码示例（参考）

```python
# models.py 中添加

class SafetyCheckType(Base):
    """安全检查类型模型"""
    __tablename__ = "safety_check_types"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), unique=True, nullable=False)
    description = Column(Text, nullable=True)
    check_items = Column(Text, nullable=True)  # JSON格式
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    
    # 关系
    created_by = relationship("User", foreign_keys=[created_by_id])
    tasks = relationship("SafetyCheckTask", back_populates="check_type")


class SafetyCheckTask(Base):
    """安全检查任务模型"""
    __tablename__ = "safety_check_tasks"
    
    id = Column(Integer, primary_key=True, index=True)
    task_number = Column(String(50), unique=True, nullable=False, index=True)
    check_type_id = Column(Integer, ForeignKey("safety_check_types.id"), nullable=False)
    title = Column(String(200), nullable=False)
    description = Column(Text, nullable=True)
    deadline = Column(DateTime(timezone=True), nullable=True)
    status = Column(String(20), default="pending", nullable=False)
    created_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    completed_at = Column(DateTime(timezone=True), nullable=True)
    
    # 关系
    check_type = relationship("SafetyCheckType", back_populates="tasks")
    created_by = relationship("User", foreign_keys=[created_by_id])
    task_assets = relationship("TaskAsset", back_populates="task")


class TaskAsset(Base):
    """任务资产关联模型"""
    __tablename__ = "task_assets"
    
    id = Column(Integer, primary_key=True, index=True)
    task_id = Column(Integer, ForeignKey("safety_check_tasks.id"), nullable=False)
    asset_id = Column(Integer, ForeignKey("assets.id"), nullable=False)
    assigned_user_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    status = Column(String(20), default="pending", nullable=False)
    check_result = Column(String(20), nullable=True)
    check_comment = Column(Text, nullable=True)
    check_items_result = Column(Text, nullable=True)  # JSON格式
    checked_at = Column(DateTime(timezone=True), nullable=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    
    # 关系
    task = relationship("SafetyCheckTask", back_populates="task_assets")
    asset = relationship("Asset")
    assigned_user = relationship("User", foreign_keys=[assigned_user_id])
    history_records = relationship("SafetyCheckHistory", back_populates="task_asset")


class SafetyCheckHistory(Base):
    """安全检查历史记录模型"""
    __tablename__ = "safety_check_history"
    
    id = Column(Integer, primary_key=True, index=True)
    task_id = Column(Integer, ForeignKey("safety_check_tasks.id"), nullable=False)
    task_asset_id = Column(Integer, ForeignKey("task_assets.id"), nullable=False)
    asset_id = Column(Integer, ForeignKey("assets.id"), nullable=False)
    check_type_id = Column(Integer, ForeignKey("safety_check_types.id"), nullable=False)
    checked_by_id = Column(Integer, ForeignKey("users.id"), nullable=False)
    check_result = Column(String(20), nullable=False)
    check_comment = Column(Text, nullable=True)
    check_items_result = Column(Text, nullable=True)  # JSON格式
    checked_at = Column(DateTime(timezone=True), nullable=False)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    
    # 关系
    task = relationship("SafetyCheckTask")
    task_asset = relationship("TaskAsset", back_populates="history_records")
    asset = relationship("Asset")
    check_type = relationship("SafetyCheckType")
    checked_by = relationship("User", foreign_keys=[checked_by_id])
```

---

## 四、前端UI实现方案

### 4.1 页面结构

```
frontend/src/pages/
├── SafetyCheckTypeManagement.jsx    # 检查类型管理（管理员）
├── SafetyCheckTaskManagement.jsx    # 任务管理（管理员）
├── MySafetyCheckTasks.jsx           # 我的检查任务（普通用户）
└── SafetyCheckHistory.jsx           # 检查历史记录
```

### 4.2 检查类型管理页面（SafetyCheckTypeManagement.jsx）

**功能**：管理员管理检查类型

**UI设计**：
```
┌─────────────────────────────────────────┐
│  安全检查类型管理                        │
├─────────────────────────────────────────┤
│  [新增检查类型]                          │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 搜索: [________]  [搜索] [重置]  │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 类型名称    │ 检查项数量 │ 状态 │ 操作│
│  ├──────────────────────────────────┤  │
│  │ 消防安全检查 │ 3项      │ 启用 │编辑│
│  │ 电气安全检查 │ 5项      │ 启用 │编辑│
│  │ 设备安全检查 │ 4项      │ 停用 │编辑│
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

**关键功能**：
1. **列表展示**：显示所有检查类型，支持搜索
2. **新增/编辑弹窗**：
   - 检查类型名称
   - 描述
   - 检查项列表（动态添加/删除）：
     - 检查项名称
     - 是否必填（复选框）
   - 启用/停用状态
3. **删除功能**：软删除，已使用的类型不能删除

**检查项编辑UI**：
```
┌─────────────────────────────────────┐
│ 检查项列表                           │
├─────────────────────────────────────┤
│ [新增检查项]                         │
│                                      │
│ ┌────────────────────────────────┐ │
│ │ 1. 灭火器是否在有效期内  [必填]│ │
│ │    [删除]                      │ │
│ ├────────────────────────────────┤ │
│ │ 2. 消防通道是否畅通      [必填]│ │
│ │    [删除]                      │ │
│ ├────────────────────────────────┤ │
│ │ 3. 烟雾报警器是否正常    [可选]│ │
│ │    [删除]                      │ │
│ └────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 4.3 任务管理页面（SafetyCheckTaskManagement.jsx）

**功能**：管理员创建和管理任务

**UI设计**：
```
┌─────────────────────────────────────────┐
│  安全检查任务管理                        │
├─────────────────────────────────────────┤
│  [发布新任务]                            │
│                                          │
│  筛选: [检查类型▼] [状态▼] [搜索] [重置]│
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 任务编号 │ 标题 │ 类型 │ 进度 │状态│操作│
│  ├──────────────────────────────────┤  │
│  │ SAFETY- │ 2025 │ 消防 │ 30/50 │进行│查看│
│  │ 2025-001│ Q1   │ 安全 │       │中  │    │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

**发布新任务流程**：

**步骤1：选择检查类型和资产**
```
┌─────────────────────────────────────────┐
│  发布安全检查任务 - 步骤1/3              │
├─────────────────────────────────────────┤
│  检查类型: [消防安全检查 ▼]             │
│                                          │
│  资产筛选:                               │
│  - 资产编号: [________]                 │
│  - 资产大类: [全部 ▼]                   │
│  - 状态: [全部 ▼]                       │
│  - 使用人: [全部 ▼]                     │
│  [搜索资产]                              │
│                                          │
│  已选资产 (3):                           │
│  ┌──────────────────────────────────┐  │
│  │ ☑ ASSET001 主机 (张三) [移除]    │  │
│  │ ☑ ASSET002 显示器 (李四) [移除]  │  │
│  │ ☑ ASSET003 打印机 (王五) [移除]  │  │
│  └──────────────────────────────────┘  │
│                                          │
│  资产列表:                               │
│  ┌──────────────────────────────────┐  │
│  │ ☐ ASSET004 主机 (赵六)          │  │
│  │ ☐ ASSET005 显示器 (钱七)        │  │
│  │ ☐ ASSET006 打印机 (孙八)        │  │
│  └──────────────────────────────────┘  │
│  [全选] [下一页]                        │
│                                          │
│  [上一步] [下一步]                      │
└─────────────────────────────────────────┘
```

**步骤2：设置任务信息**
```
┌─────────────────────────────────────────┐
│  发布安全检查任务 - 步骤2/3              │
├─────────────────────────────────────────┤
│  任务标题: [________________]           │
│  任务描述: [________________]           │
│           [________________]             │
│                                          │
│  截止时间: [2025-03-31] [23:59]        │
│  (可选，留空表示无截止时间)              │
│                                          │
│  任务预览:                               │
│  - 检查类型: 消防安全检查                │
│  - 资产数量: 3                           │
│  - 分配用户: 3人                         │
│                                          │
│  [上一步] [下一步]                      │
└─────────────────────────────────────────┘
```

**步骤3：确认发布**
```
┌─────────────────────────────────────────┐
│  发布安全检查任务 - 步骤3/3              │
├─────────────────────────────────────────┤
│  请确认任务信息:                         │
│                                          │
│  任务标题: 2025年第一季度消防安全检查   │
│  检查类型: 消防安全检查                 │
│  资产数量: 3                             │
│  分配用户:                                │
│    - 张三 (1项)                          │
│    - 李四 (1项)                          │
│    - 王五 (1项)                          │
│  截止时间: 2025-03-31 23:59            │
│                                          │
│  [上一步] [确认发布]                    │
└─────────────────────────────────────────┘
```

**任务详情页面**：
```
┌─────────────────────────────────────────┐
│  任务详情: SAFETY-2025-001              │
├─────────────────────────────────────────┤
│  任务信息:                               │
│  - 标题: 2025年第一季度消防安全检查     │
│  - 类型: 消防安全检查                    │
│  - 状态: 进行中                          │
│  - 进度: 30/50 (60%)                    │
│  - 截止时间: 2025-03-31 23:59           │
│                                          │
│  资产列表:                               │
│  ┌──────────────────────────────────┐  │
│  │ 资产编号 │ 名称 │ 使用人 │ 状态 │  │
│  ├──────────────────────────────────┤  │
│  │ ASSET001 │ 主机 │ 张三  │ 已完成│  │
│  │ ASSET002 │ 显示器│ 李四 │ 待检查│  │
│  │ ASSET003 │ 打印机│ 王五 │ 待检查│  │
│  └──────────────────────────────────┘  │
│                                          │
│  [返回] [导出]                          │
└─────────────────────────────────────────┘
```

### 4.4 我的检查任务页面（MySafetyCheckTasks.jsx）

**功能**：普通用户查看和完成检查任务

**UI设计**：
```
┌─────────────────────────────────────────┐
│  我的安全检查任务                        │
├─────────────────────────────────────────┤
│  标签页: [待检查(3)] [已完成(5)] [全部] │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 任务编号: SAFETY-2025-001        │  │
│  │ 任务标题: 2025年第一季度消防安全检查│
│  │ 检查类型: 消防安全检查            │  │
│  │ 待检查: 3项                        │  │
│  │ 截止时间: 2025-03-31 23:59        │  │
│  │ [查看详情] [开始检查]              │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 任务编号: SAFETY-2025-002        │  │
│  │ 任务标题: 2025年第一季度电气安全检查│
│  │ 检查类型: 电气安全检查            │  │
│  │ 待检查: 2项                        │  │
│  │ 截止时间: 2025-03-31 23:59        │  │
│  │ [查看详情] [开始检查]              │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

**检查详情页面**：
```
┌─────────────────────────────────────────┐
│  安全检查: SAFETY-2025-001               │
├─────────────────────────────────────────┤
│  任务信息:                               │
│  - 任务标题: 2025年第一季度消防安全检查 │
│  - 检查类型: 消防安全检查                │
│  - 截止时间: 2025-03-31 23:59           │
│                                          │
│  待检查资产 (3项):                       │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 资产: ASSET001 - 主机             │  │
│  │ 使用人: 张三                       │  │
│  │ 存放地点: 办公楼A 3F              │  │
│  ├──────────────────────────────────┤  │
│  │ 检查项:                            │  │
│  │ 1. 灭火器是否在有效期内 [必填]    │  │
│  │    结果: [通过○] [不通过○] [警告○]│  │
│  │    备注: [________________]       │  │
│  │                                    │  │
│  │ 2. 消防通道是否畅通 [必填]        │  │
│  │    结果: [通过○] [不通过○] [警告○]│  │
│  │    备注: [________________]       │  │
│  │                                    │  │
│  │ 3. 烟雾报警器是否正常 [可选]      │  │
│  │    结果: [通过○] [不通过○] [警告○]│  │
│  │    备注: [________________]       │  │
│  │                                    │  │
│  │ 整体结果: [通过○] [不通过○] [警告○]│  │
│  │ 检查备注: [________________]      │  │
│  │           [________________]      │  │
│  │                                    │  │
│  │ [保存草稿] [提交检查结果]          │  │
│  └──────────────────────────────────┘  │
│                                          │
│  [上一个] [下一个] [返回列表]            │
└─────────────────────────────────────────┘
```

**检查结果提交确认**：
```
┌─────────────────────────────────────────┐
│  确认提交检查结果                        │
├─────────────────────────────────────────┤
│  资产: ASSET001 - 主机                  │
│  检查结果: 通过                          │
│                                          │
│  检查项结果:                              │
│  ✓ 灭火器是否在有效期内: 通过            │
│  ✓ 消防通道是否畅通: 通过                │
│  ✓ 烟雾报警器是否正常: 通过              │
│                                          │
│  检查备注: 所有检查项均正常               │
│                                          │
│  [取消] [确认提交]                      │
└─────────────────────────────────────────┘
```

### 4.5 检查历史记录页面（SafetyCheckHistory.jsx）

**功能**：查看资产或任务的检查历史

**UI设计**：
```
┌─────────────────────────────────────────┐
│  安全检查历史记录                        │
├─────────────────────────────────────────┤
│  筛选: [资产编号▼] [检查类型▼] [搜索]  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │ 检查时间 │ 资产 │ 类型 │ 结果 │操作人│
│  ├──────────────────────────────────┤  │
│  │ 2025-01-15│ASSET001│消防│通过│张三│
│  │ 2025-01-10│ASSET001│电气│通过│张三│
│  │ 2024-12-20│ASSET001│消防│通过│张三│
│  └──────────────────────────────────┘  │
│                                          │
│  点击查看详情:                            │
│  ┌──────────────────────────────────┐  │
│  │ 任务: SAFETY-2025-001             │  │
│  │ 资产: ASSET001 - 主机             │  │
│  │ 检查类型: 消防安全检查            │  │
│  │ 检查结果: 通过                      │  │
│  │ 检查人: 张三                        │  │
│  │ 检查时间: 2025-01-15 10:30         │  │
│  │                                    │  │
│  │ 检查项结果:                         │  │
│  │ 1. 灭火器是否在有效期内: 通过      │  │
│  │    备注: 有效期至2025-12-31        │  │
│  │ 2. 消防通道是否畅通: 通过          │  │
│  │    备注: 通道畅通                  │  │
│  │ 3. 烟雾报警器是否正常: 通过        │  │
│  │    备注: 正常                      │  │
│  │                                    │  │
│  │ 检查备注: 所有检查项均正常          │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 4.6 菜单集成

在 `Layout.jsx` 中添加菜单项：

**管理员菜单**：
```javascript
{
  key: '/safety-check-types',
  icon: <SafetyOutlined />,
  label: '检查类型管理'
},
{
  key: '/safety-check-tasks',
  icon: <FileTextOutlined />,
  label: '安全检查任务'
}
```

**普通用户菜单**：
```javascript
{
  key: '/my-safety-check-tasks',
  icon: <CheckCircleOutlined />,
  label: '我的检查任务'
}
```

### 4.7 首页统计集成

在 `Dashboard.jsx` 中添加统计卡片：

```javascript
// 待检查任务数量（普通用户）
// 进行中的任务数量（管理员）
// 已完成的检查数量（管理员）
```

---

## 五、关键设计决策

### 5.1 检查类型动态管理

**方案**：使用独立的检查类型表，支持动态添加、编辑、停用

**优势**：
- 灵活性高，可以随时添加新的检查类型
- 检查项可以配置，支持必填/可选
- 历史记录可以追溯检查类型信息

### 5.2 任务分配策略

**方案**：自动分配给资产使用人

**处理边界情况**：
1. **资产没有使用人**：
   - 推荐：跳过该资产，不加入任务
   - 备选：分配给管理员或标记为待分配
2. **资产使用人已离职**：
   - 标记为待分配，管理员手动重新分配
3. **一个用户有多个资产**：
   - 每个资产单独分配，用户可以看到所有分配给自己的资产

### 5.3 检查结果存储

**方案**：使用JSON格式存储检查项结果

**优势**：
- 灵活，可以适应不同检查类型的检查项
- 便于扩展，可以添加新的检查项字段
- 便于查询和展示

### 5.4 任务状态管理

**方案**：任务状态根据所有资产检查状态自动计算

**状态流转**：
- `pending` → `completed`（所有资产都完成）
- `pending` → `overdue`（超过截止时间）
- `pending` → `cancelled`（管理员取消）

### 5.5 历史记录设计

**方案**：每次检查完成后创建历史记录，不可修改

**优势**：
- 完整的审计追踪
- 可以查看资产的历史检查记录
- 可以分析检查趋势

---

## 六、扩展建议

### 6.1 短期扩展

1. **任务提醒**：截止时间前提醒用户
2. **批量操作**：支持批量提交检查结果
3. **检查模板**：保存常用的检查类型配置
4. **导出功能**：导出检查报告

### 6.2 中期扩展

1. **检查计划**：定期自动创建检查任务
2. **检查统计**：检查完成率、通过率等统计
3. **异常处理**：不通过检查的资产自动标记
4. **通知功能**：检查结果通知相关人员

### 6.3 长期扩展

1. **移动端支持**：手机端完成检查
2. **照片上传**：检查时上传照片
3. **签名功能**：检查人电子签名
4. **检查报告生成**：自动生成检查报告

---

## 七、实施建议

### 7.1 开发顺序

1. **第一阶段**：数据库设计和基础模型
   - 创建数据表
   - 创建数据模型
   - 创建Pydantic模式

2. **第二阶段**：后端API开发
   - 检查类型管理API
   - 任务管理API
   - 检查结果提交API

3. **第三阶段**：前端页面开发
   - 检查类型管理页面
   - 任务管理页面
   - 我的检查任务页面

4. **第四阶段**：测试和优化
   - 功能测试
   - 性能优化
   - 用户体验优化

### 7.2 注意事项

1. **数据迁移**：如果已有数据，需要考虑数据迁移
2. **权限控制**：确保权限控制正确实现
3. **性能优化**：大量资产时，考虑分页和索引
4. **用户体验**：提供清晰的操作指引和反馈

---

## 八、总结

本方案提供了一个完整的安全检查功能实现方案，包括：

1. **灵活的数据库设计**：支持动态检查类型，完整的任务和结果管理
2. **清晰的后端API设计**：RESTful风格，权限控制明确
3. **友好的前端UI设计**：分步骤操作，清晰的信息展示
4. **完善的业务逻辑**：处理各种边界情况，自动状态管理

该方案可以满足当前需求，同时为未来扩展预留了空间。

