# 数据库配置示例

本文档提供快速配置示例，帮助快速切换数据库。

## 快速配置指南

### 方式1：环境变量配置（推荐）

#### Windows PowerShell

```powershell
# Oracle配置
$env:DB_TYPE="oracle"
$env:DB_USER="asset_user"
$env:DB_PASSWORD="your_password"
$env:DB_HOST="192.168.1.100"
$env:DB_PORT="1521"
$env:DB_SERVICE_NAME="ORCL"

# 启动应用
cd backend
python -m uvicorn main:app --reload
```

#### Linux/Mac Bash

```bash
# Oracle配置
export DB_TYPE=oracle
export DB_USER=asset_user
export DB_PASSWORD=your_password
export DB_HOST=192.168.1.100
export DB_PORT=1521
export DB_SERVICE_NAME=ORCL

# 启动应用
cd backend
python -m uvicorn main:app --reload
```

#### SQL Server配置

```bash
# SQL Server配置
export DB_TYPE=sqlserver
export DB_USER=sa
export DB_PASSWORD=your_password
export DB_HOST=192.168.1.100
export DB_PORT=1433
export DB_NAME=asset_management
export DB_DRIVER="ODBC Driver 17 for SQL Server"
```

### 方式2：.env文件配置（推荐用于生产环境）

创建 `backend/.env` 文件：

```env
# ============================================
# 数据库配置
# ============================================
# 数据库类型：sqlite, oracle, sqlserver
DB_TYPE=oracle

# ============================================
# Oracle配置（当DB_TYPE=oracle时使用）
# ============================================
DB_USER=asset_user
DB_PASSWORD=your_secure_password
DB_HOST=192.168.1.100
DB_PORT=1521
DB_SERVICE_NAME=ORCL
# 或者使用SID（二选一）
# DB_SID=ORCL

# ============================================
# SQL Server配置（当DB_TYPE=sqlserver时使用）
# ============================================
# DB_USER=sa
# DB_PASSWORD=your_secure_password
# DB_HOST=192.168.1.100
# DB_PORT=1433
# DB_NAME=asset_management
# DB_DRIVER=ODBC Driver 17 for SQL Server

# ============================================
# 连接池配置（可选）
# ============================================
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10
DB_POOL_PRE_PING=true
```

### 方式3：配置文件（JSON格式）

创建 `backend/database_config.json`：

```json
{
  "db_type": "oracle",
  "oracle": {
    "user": "asset_user",
    "password": "your_secure_password",
    "host": "192.168.1.100",
    "port": "1521",
    "service_name": "ORCL"
  },
  "sqlserver": {
    "user": "sa",
    "password": "your_secure_password",
    "host": "192.168.1.100",
    "port": "1433",
    "database": "asset_management",
    "driver": "ODBC Driver 17 for SQL Server"
  },
  "pool": {
    "size": 5,
    "max_overflow": 10,
    "pre_ping": true
  }
}
```

## 连接字符串示例

### Oracle连接字符串

```
# 使用Service Name（推荐）
oracle+cx_oracle://username:password@host:1521/?service_name=ORCL

# 使用SID
oracle+cx_oracle://username:password@host:1521/ORCL

# 使用TNS名称
oracle+cx_oracle://username:password@tns_name
```

### SQL Server连接字符串

```
# 标准连接
mssql+pyodbc://username:password@host:1433/database?driver=ODBC+Driver+17+for+SQL+Server

# 使用Windows认证（如果支持）
mssql+pyodbc://host:1433/database?driver=ODBC+Driver+17+for+SQL+Server&trusted_connection=yes
```

## 依赖安装

### Oracle

```bash
# 方式1：使用cx_Oracle（需要Oracle客户端）
pip install cx_Oracle

# 方式2：使用oracledb（纯Python，推荐）
pip install oracledb
```

**Oracle客户端安装**（如果使用cx_Oracle）：
- Windows：下载Oracle Instant Client
- Linux：`yum install oracle-instantclient-basic oracle-instantclient-devel`

### SQL Server

```bash
pip install pyodbc
```

**ODBC驱动安装**：
- Windows：通常已预装，或下载"ODBC Driver 17 for SQL Server"
- Linux：安装Microsoft ODBC驱动

## 测试连接

创建 `backend/test_db_connection.py`：

```python
"""测试数据库连接"""
import os
from sqlalchemy import create_engine, text

# 从环境变量读取配置
DB_TYPE = os.getenv("DB_TYPE", "sqlite")

if DB_TYPE == "oracle":
    DB_USER = os.getenv("DB_USER")
    DB_PASSWORD = os.getenv("DB_PASSWORD")
    DB_HOST = os.getenv("DB_HOST")
    DB_PORT = os.getenv("DB_PORT", "1521")
    DB_SERVICE_NAME = os.getenv("DB_SERVICE_NAME")
    
    url = f"oracle+cx_oracle://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/?service_name={DB_SERVICE_NAME}"
    
elif DB_TYPE == "sqlserver":
    from urllib.parse import quote_plus
    DB_USER = os.getenv("DB_USER")
    DB_PASSWORD = os.getenv("DB_PASSWORD")
    DB_HOST = os.getenv("DB_HOST")
    DB_PORT = os.getenv("DB_PORT", "1433")
    DB_NAME = os.getenv("DB_NAME")
    DB_DRIVER = os.getenv("DB_DRIVER", "ODBC Driver 17 for SQL Server")
    
    url = f"mssql+pyodbc://{quote_plus(DB_USER)}:{quote_plus(DB_PASSWORD)}@{DB_HOST}:{DB_PORT}/{DB_NAME}?driver={quote_plus(DB_DRIVER)}"
    
else:
    url = "sqlite:///assets.db"

try:
    engine = create_engine(url, pool_pre_ping=True)
    with engine.connect() as conn:
        result = conn.execute(text("SELECT 1"))
        print(f"✅ 数据库连接成功！类型: {DB_TYPE}")
        print(f"连接字符串: {url.replace(DB_PASSWORD if 'DB_PASSWORD' in locals() else '', '***')}")
except Exception as e:
    print(f"❌ 数据库连接失败: {e}")
```

运行测试：
```bash
python test_db_connection.py
```

## 常见问题

### Oracle连接失败

1. **错误：ORA-12541: TNS:no listener**
   - 检查主机和端口是否正确
   - 检查Oracle监听器是否启动

2. **错误：ORA-01017: invalid username/password**
   - 检查用户名和密码
   - 检查用户是否被锁定

3. **错误：ORA-12154: TNS:could not resolve the connect identifier**
   - 检查Service Name或SID是否正确
   - 检查tnsnames.ora配置

### SQL Server连接失败

1. **错误：Driver not found**
   - 检查ODBC驱动是否安装
   - 检查驱动名称是否正确

2. **错误：Login failed**
   - 检查用户名和密码
   - 检查SQL Server是否允许SQL认证

3. **错误：Network-related error**
   - 检查主机和端口
   - 检查防火墙设置
   - 检查SQL Server是否允许远程连接

## 安全建议

1. **密码管理**：
   - 使用强密码
   - 定期更换密码
   - 不要在代码中硬编码密码
   - 使用密钥管理服务（如Vault）

2. **连接加密**：
   - Oracle：使用SSL/TLS连接
   - SQL Server：使用加密连接

3. **权限最小化**：
   - 只授予必要的权限
   - 使用只读账户进行查询
   - 分离应用账户和管理账户

4. **网络安全**：
   - 使用VPN或专用网络
   - 限制数据库访问IP
   - 使用防火墙规则

