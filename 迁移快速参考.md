# 迁移快速参考卡片

本文档提供迁移过程中的关键命令和检查点，详细步骤请参考 [内网迁移指南.md](内网迁移指南.md)。

## 一、准备工作（5分钟）

### 1. 备份SQLite数据库
```bash
cd backend
cp assets.db assets_backup_$(date +%Y%m%d_%H%M%S).db
```

### 2. 安装依赖
```bash
# Oracle
pip install cx_Oracle python-dotenv
# 或
pip install oracledb python-dotenv

# SQL Server
pip install pyodbc python-dotenv
```

### 3. 更新requirements.txt
添加相应的数据库驱动和python-dotenv

---

## 二、代码配置化（30分钟）

### 1. 备份database.py
```bash
cp database.py database.py.backup
```

### 2. 修改database.py
参考 [内网迁移指南.md](内网迁移指南.md) 中的完整代码

### 3. 创建.env文件
```env
DB_TYPE=oracle
DB_USER=asset_user
DB_PASSWORD=your_password
DB_HOST=192.168.1.100
DB_PORT=1521
DB_SERVICE_NAME=ORCL
```

### 4. 测试配置
```bash
python test_db_config.py
```

---

## 三、数据库准备（30-60分钟）

### Oracle

```sql
-- 1. 创建用户
CREATE USER asset_user IDENTIFIED BY your_password;
GRANT CONNECT, RESOURCE, CREATE SESSION, CREATE TABLE, CREATE SEQUENCE TO asset_user;
GRANT UNLIMITED TABLESPACE TO asset_user;
COMMIT;

-- 2. 验证
CONNECT asset_user/your_password@host:port/service_name;
SELECT 1 FROM DUAL;
```

### SQL Server

```sql
-- 1. 创建数据库
CREATE DATABASE asset_management COLLATE Chinese_PRC_CI_AS;
GO

-- 2. 创建用户
USE master;
GO
CREATE LOGIN asset_user WITH PASSWORD = 'your_password';
GO

USE asset_management;
GO
CREATE USER asset_user FOR LOGIN asset_user;
GO
ALTER ROLE db_owner ADD MEMBER asset_user;
GO
```

### 测试连接
```bash
python test_connection.py
```

---

## 四、创建表结构（5分钟）

```bash
python create_tables.py
```

**验证**：
- Oracle: `SELECT table_name FROM user_tables;`
- SQL Server: `SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES;`

---

## 五、数据迁移（30-60分钟）

### 1. 运行迁移脚本
```bash
python migrate_data.py
```

### 2. 验证数据
```bash
python verify_migration.py
```

**检查点**：
- [ ] 所有表记录数匹配
- [ ] 无错误信息
- [ ] 关键数据验证通过

---

## 六、功能测试（60-120分钟）

### 1. 启动服务
```bash
python -m uvicorn main:app --reload --port 8000
```

### 2. 测试清单
- [ ] 登录功能
- [ ] 用户管理
- [ ] 资产管理
- [ ] 资产交接
- [ ] 资产退回
- [ ] 审批流程
- [ ] 安全检查任务
- [ ] 批量导入

### 3. 性能测试
```bash
python test_performance.py
```

---

## 七、常见问题快速解决

### 连接失败
1. 检查网络：`ping 数据库IP`
2. 检查端口：`telnet 数据库IP 端口`
3. 检查防火墙
4. 检查用户名密码

### 字符乱码
- Oracle: 检查字符集是否为AL32UTF8
- SQL Server: 检查排序规则是否包含Chinese_PRC

### 性能慢
1. 添加索引
2. 优化连接池大小
3. 分析慢查询

---

## 八、环境变量速查

### Oracle
```bash
export DB_TYPE=oracle
export DB_USER=asset_user
export DB_PASSWORD=password
export DB_HOST=192.168.1.100
export DB_PORT=1521
export DB_SERVICE_NAME=ORCL
```

### SQL Server
```bash
export DB_TYPE=sqlserver
export DB_USER=sa
export DB_PASSWORD=password
export DB_HOST=192.168.1.100
export DB_PORT=1433
export DB_NAME=asset_management
export DB_DRIVER="ODBC Driver 17 for SQL Server"
```

---

## 九、验证检查清单

### 迁移前
- [ ] SQLite数据库已备份
- [ ] 依赖已安装
- [ ] 代码已配置化

### 数据库准备
- [ ] 数据库用户已创建
- [ ] 权限已授予
- [ ] 连接测试通过

### 数据迁移
- [ ] 表结构已创建
- [ ] 数据已迁移
- [ ] 数据完整性验证通过

### 功能测试
- [ ] 所有功能测试通过
- [ ] 性能测试通过
- [ ] 无错误日志

### 上线前
- [ ] 生产环境配置已准备
- [ ] 备份方案已准备
- [ ] 回滚方案已准备
- [ ] 监控已配置

---

## 十、紧急回滚

如果迁移出现问题，快速回滚：

1. **停止新服务**
2. **恢复SQLite配置**
   ```bash
   # 删除或注释.env文件中的DB_TYPE
   # 或设置
   export DB_TYPE=sqlite
   ```
3. **恢复SQLite数据库**
   ```bash
   cp assets_backup_*.db assets.db
   ```
4. **重启服务**

---

## 联系支持

- 查看详细指南：[内网迁移指南.md](内网迁移指南.md)
- 查看配置示例：[数据库配置示例.md](数据库配置示例.md)
- 数据库管理员
- 项目维护者

